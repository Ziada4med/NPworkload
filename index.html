<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProcureTrack - Procurement Performance System</title>
    
    <!-- Libraries: Tailwind CSS, FontAwesome, Chart.js, Supabase -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Gantt Chart Styles */
        .gantt-wrapper {
            font-size: 12px;
        }
        .bg-slate-25 {
            background-color: #fafafa;
        }
        /* Horizontal scrollbar for gantt */
        .gantt-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }
        
        /* Loading styles */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden">

    <!-- APP CONTAINER -->
    <div id="app" class="h-full flex flex-col">
        <!-- Javascript will inject views here -->
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        /**
         * ------------------------------------------------------------------
         * SUPABASE CONFIGURATION
         * ------------------------------------------------------------------
         */
        const SUPABASE_URL = 'https://eyicakgpbwkplhkhqnjd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5aWNha2dwYndrcGxoa2hxbmpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0Nzc5OTMsImV4cCI6MjA4MTA1Mzk5M30.Bb-rxLpNuRwng0WA0YF2Ua_aUOx6ACrvBcqcvp46KOw';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        /**
         * ------------------------------------------------------------------
         * SCORING SYSTEM - PERFORMANCE CALCULATION
         * ------------------------------------------------------------------
         */
        const ScoringService = {
            // Calculate performance score for a completed task
            calculateTaskPerformanceScore: (task) => {
                if (!task || task.status !== 'Closed') {
                    return null; // Only calculate for completed tasks
                }

                const milestones = ScoringService.getTaskMilestones(task);
                if (milestones.length === 0) return 0;

                let totalScore = 0;
                let completedMilestones = 0;

                milestones.forEach(milestone => {
                    if (milestone.actual && milestone.planned) {
                        const plannedDate = new Date(milestone.planned);
                        const actualDate = new Date(milestone.actual);
                        const daysDifference = Math.ceil((actualDate - plannedDate) / (1000 * 60 * 60 * 24));

                        let milestoneScore = 0;
                        if (daysDifference <= 0) milestoneScore = 10; // Early or on time
                        else if (daysDifference <= 1) milestoneScore = 8; // 1 day late
                        else if (daysDifference <= 3) milestoneScore = 6; // 2-3 days late
                        else if (daysDifference <= 7) milestoneScore = 4; // 4-7 days late
                        else if (daysDifference <= 14) milestoneScore = 2; // 8-14 days late
                        else milestoneScore = 0; // >14 days late

                        totalScore += milestoneScore;
                        completedMilestones++;
                    }
                });

                return completedMilestones > 0 ? Math.round((totalScore / completedMilestones) * 100) / 100 : 0;
            },

            // Calculate ongoing task score using time-to-completion algorithm
            calculateOngoingTaskScore: (task) => {
                if (task.status === 'Closed' || task.status === 'Cancelled') {
                    return ScoringService.calculateTaskPerformanceScore(task);
                }

                const milestones = ScoringService.getTaskMilestones(task);
                if (milestones.length === 0) return 5; // Default score for tasks without milestones

                const totalMilestones = milestones.length;
                const completedMilestones = milestones.filter(m => m.actual).length;
                
                // Calculate expected progress
                const assignmentDate = new Date(task.assignment_date);
                const today = new Date();
                const lastMilestonePlanned = Math.max(...milestones.filter(m => m.planned).map(m => new Date(m.planned).getTime()));
                const totalTaskDays = Math.max(1, Math.ceil((lastMilestonePlanned - assignmentDate.getTime()) / (1000 * 60 * 60 * 24)));
                const elapsedDays = Math.ceil((today.getTime() - assignmentDate.getTime()) / (1000 * 60 * 60 * 24));
                
                const expectedProgress = Math.min(1, Math.max(0, elapsedDays / totalTaskDays));
                const actualProgress = completedMilestones / totalMilestones;
                
                // Performance ratio
                const performanceRatio = expectedProgress > 0 ? actualProgress / expectedProgress : 1;
                
                // Convert to score
                if (performanceRatio >= 1.2) return 10; // 20% ahead
                if (performanceRatio >= 1.0) return 9;  // On track
                if (performanceRatio >= 0.8) return 7;  // Slightly behind
                if (performanceRatio >= 0.6) return 5;  // Behind schedule
                if (performanceRatio >= 0.4) return 3;  // Significantly behind
                return 1; // Critical delay
            },

            // Get structured milestone data
            getTaskMilestones: (task) => {
                const milestones = [];
                
                if (task.type === 'new') {
                    const sequence = ['vendor_list', 'rfq_float', 'target_prices', 'comparison'];
                    const labels = ['Vendor List', 'RFQ Float', 'Target Prices', 'Comparison'];
                    
                    // Add the standard milestones
                    sequence.forEach((key, index) => {
                        const planned = task.milestones[key];
                        const actual = task.milestones[`${key}_actual`];
                        
                        if (planned) {
                            milestones.push({
                                key,
                                label: labels[index],
                                planned,
                                actual,
                                order: index
                            });
                        }
                    });
                    
                    // Add material submittal milestones for permanent PRs
                    if (task.is_permanent && task.milestones.material_submittal_required === 'Yes') {
                        const materialSubmittals = [
                            { key: 'material_submittal_submitted', label: 'Material Submittal' },
                            { key: 'material_submittal_approved', label: 'Submittal Approval' }
                        ];
                        
                        materialSubmittals.forEach((ms, index) => {
                            const planned = task.milestones[ms.key];
                            const actual = task.milestones[`${ms.key}_actual`];
                            
                            if (planned) {
                                milestones.push({
                                    key: ms.key,
                                    label: ms.label,
                                    planned,
                                    actual,
                                    order: sequence.length + index
                                });
                            }
                        });
                    }
                    
                    // Add PO issuance as final milestone
                    const poPlanned = task.milestones.po_issuance;
                    const poActual = task.milestones.po_issuance_actual;
                    if (poPlanned) {
                        milestones.push({
                            key: 'po_issuance',
                            label: 'PO Issue',
                            planned: poPlanned,
                            actual: poActual,
                            order: 100 // Always last
                        });
                    }
                    
                } else {
                    // Repeat request milestones (no material submittal)
                    const sequence = ['prices_confirm', 'comparison', 'po_issuance'];
                    const labels = ['Price Confirm', 'Comparison', 'PO Issue'];
                    
                    sequence.forEach((key, index) => {
                        const planned = task.milestones[key];
                        const actual = task.milestones[`${key}_actual`];
                        
                        if (planned) {
                            milestones.push({
                                key,
                                label: labels[index],
                                planned,
                                actual,
                                order: index
                            });
                        }
                    });
                }
                
                return milestones;
            },

            // Calculate overall user score
            calculateUserScore: (userId) => {
                const allTasks = db.getTasks().filter(t => t.owner_id === userId);
                if (allTasks.length === 0) return 0;

                let totalWeightedScore = 0;
                let totalWeight = 0;

                allTasks.forEach(task => {
                    const taskScore = task.status === 'Closed' ? 
                        task.performance_score || ScoringService.calculateTaskPerformanceScore(task) :
                        ScoringService.calculateOngoingTaskScore(task);
                    
                    if (taskScore !== null) {
                        // Recency factor (tasks from last 90 days get more weight)
                        const taskAge = ScoringService.getTaskAgeInWeeks(task.completion_date || new Date());
                        const recencyFactor = Math.max(0.3, 1 - (taskAge * 0.1));
                        
                        // Complexity bonus for high-weight tasks
                        const taskWeight = task.task_weight || 5;
                        const complexityMultiplier = taskWeight >= 7 ? 1.2 : 1.0;
                        
                        const adjustedWeight = taskWeight * recencyFactor * complexityMultiplier;
                        totalWeightedScore += taskScore * adjustedWeight;
                        totalWeight += adjustedWeight;
                    }
                });

                return totalWeight > 0 ? Math.min(10, Math.round((totalWeightedScore / totalWeight) * 100) / 100) : 0;
            },

            // Helper function to get task age in weeks
            getTaskAgeInWeeks: (date) => {
                const taskDate = new Date(date);
                const today = new Date();
                const diffTime = today.getTime() - taskDate.getTime();
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 7));
            },

            // Calculate the last updated date for a task
            getLastUpdatedDate: (task) => {
                const dates = [];
                
                // Add assignment date as baseline
                if (task.assignment_date) {
                    dates.push(new Date(task.assignment_date));
                }
                
                // Add all milestone actual dates
                if (task.milestones) {
                    const milestoneKeys = [
                        'vendor_list_actual', 'rfq_float_actual', 'target_prices_actual', 
                        'comparison_actual', 'po_issuance_actual', 'prices_confirm_actual'
                    ];
                    
                    milestoneKeys.forEach(key => {
                        if (task.milestones[key]) {
                            dates.push(new Date(task.milestones[key]));
                        }
                    });
                }
                
                // Add remarks timestamps
                if (Array.isArray(task.remarks)) {
                    task.remarks.forEach(remark => {
                        if (remark.timestamp) {
                            dates.push(new Date(remark.timestamp));
                        }
                    });
                }
                
                // Add weight modification date
                if (task.weight_modified_at) {
                    dates.push(new Date(task.weight_modified_at));
                }
                
                // Add completion/cancellation dates
                if (task.completion_date) {
                    dates.push(new Date(task.completion_date));
                }
                if (task.cancellation_date) {
                    dates.push(new Date(task.cancellation_date));
                }
                
                // Add score calculation date
                if (task.last_score_calculation) {
                    dates.push(new Date(task.last_score_calculation));
                }
                
                // Return the latest date
                if (dates.length === 0) {
                    return task.assignment_date ? new Date(task.assignment_date) : new Date();
                }
                
                return new Date(Math.max(...dates.map(d => d.getTime())));
            },

            // Update all task scores (weekly job simulation)
            updateAllScores: async () => {
                console.log('ðŸ”„ Running weekly score calculation...');
                const allTasks = db.getTasks();
                const allUsers = db.getUsers();
                
                // Update task performance scores
                for (const task of allTasks) {
                    if (task.status === 'Closed' && !task.performance_score) {
                        const score = ScoringService.calculateTaskPerformanceScore(task);
                        if (score !== null) {
                            const updatedTask = {
                                ...task,
                                performance_score: score,
                                last_score_calculation: new Date().toISOString()
                            };
                            
                            await db.saveTask(updatedTask);
                            
                            // Update cache
                            const taskIndex = db.cache.tasks.findIndex(t => t.id === task.id);
                            if (taskIndex !== -1) {
                                db.cache.tasks[taskIndex] = updatedTask;
                            }
                        }
                    }
                }
                
                // Update user overall scores
                const userScores = {};
                for (const user of allUsers) {
                    userScores[user.id] = {
                        user_id: user.id,
                        overall_score: ScoringService.calculateUserScore(user.id),
                        last_updated: new Date().toISOString()
                    };
                }
                
                // Store in localStorage for now (would be database in production)
                localStorage.setItem('pt_user_scores', JSON.stringify(userScores));
                
                console.log('âœ… Score calculation completed');
                return userScores;
            }
        };

        /**
         * ------------------------------------------------------------------
         * SUPABASE DATABASE SERVICE
         * ------------------------------------------------------------------
         */
        class SupabaseDB {
            constructor() {
                this.cache = {
                    users: [],
                    tasks: [],
                    projects: ['Project Alpha', 'Project Beta', 'Project Gamma', 'HQ Renovation'] // Static for now
                };
            }

            async authenticate(username, password) {
                try {
                    console.log('ðŸ”„ Authenticating with Supabase...');
                    const { data, error } = await supabaseClient.rpc('authenticate_user', {
                        p_username: username,
                        p_password: password
                    });
                    
                    if (error) {
                        console.error('Authentication error:', error);
                        throw error;
                    }
                    
                    if (data && data.length > 0) {
                        console.log('âœ… Authentication successful!', data[0]);
                        // The RPC returns user_data as JSON, so we need to parse it
                        return data[0].user_data || data[0];
                    }
                    
                    throw new Error('Invalid credentials');
                } catch (error) {
                    console.error('Authentication failed:', error.message);
                    throw error;
                }
            }

            async loadUsers() {
                try {
                    console.log('ðŸ”„ Loading users from Supabase...');
                    const { data, error } = await supabaseClient.rpc('get_all_users_with_reports');
                    if (error) throw error;
                    
                    console.log('Raw users data:', data);
                    this.cache.users = data.map(item => item.user_data);
                    console.log('Processed users:', this.cache.users);
                    return this.cache.users;
                } catch (error) {
                    console.error('Error loading users:', error);
                    throw error;
                }
            }

            async loadTasks() {
                try {
                    console.log('ðŸ”„ Loading tasks from Supabase...');
                    const { data, error } = await supabaseClient
                        .from('pt_tasks')
                        .select(`
                            *,
                            owner:pt_users!pt_tasks_owner_id_fkey(id, name, role)
                        `);
                    
                    if (error) throw error;
                    
                    console.log('Raw tasks data:', data);
                    // Transform data to match the expected format
                    this.cache.tasks = data.map(task => ({
                        id: task.id,
                        owner_id: task.owner_id,
                        pr_no: task.pr_no,
                        project: task.project,
                        type: task.type,
                        is_permanent: task.is_permanent,
                        assignment_date: task.assignment_date,
                        status: task.status,
                        completion_date: task.completion_date,
                        cancellation_date: task.cancellation_date,
                        current_stage: task.current_stage || (task.type === 'new' ? 'vendor_list' : 'prices_confirm'), // Default to first milestone
                        action_by: task.action_by,
                        // Weight and score fields
                        task_weight: task.task_weight || 5,
                        weight_set_by: task.weight_set_by,
                        weight_modified_by: task.weight_modified_by,
                        weight_modified_at: task.weight_modified_at,
                        weight_modification_reason: task.weight_modification_reason,
                        performance_score: task.performance_score,
                        last_score_calculation: task.last_score_calculation,
                        // Engineer remarks (timeline-based)
                        remarks: (() => {
                            try {
                                if (typeof task.remarks === 'string' && task.remarks.startsWith('[')) {
                                    return JSON.parse(task.remarks);
                                } else if (Array.isArray(task.remarks)) {
                                    return task.remarks;
                                } else if (task.remarks) {
                                    // Legacy single remark - convert to timeline format
                                    return [{ text: task.remarks, timestamp: task.remarks_updated_at || new Date().toISOString() }];
                                }
                                return [];
                            } catch (e) {
                                // Fallback for parsing errors
                                return task.remarks ? [{ text: task.remarks, timestamp: new Date().toISOString() }] : [];
                            }
                        })(),
                        last_updated: task.last_updated,
                        milestones: {
                            // New request milestones
                            vendor_list: task.vendor_list_planned,
                            vendor_list_actual: task.vendor_list_actual,
                            rfq_float: task.rfq_float_planned,
                            rfq_float_actual: task.rfq_float_actual,
                            target_prices: task.target_prices_planned,
                            target_prices_actual: task.target_prices_actual,
                            comparison: task.comparison_planned,
                            comparison_actual: task.comparison_actual,
                            // Material submittal milestones (for permanent PRs only)
                            material_submittal_required: task.material_submittal_required, // Yes/No decision
                            material_submittal_submitted: task.material_submittal_submitted_planned,
                            material_submittal_submitted_actual: task.material_submittal_submitted_actual,
                            material_submittal_approved: task.material_submittal_approved_planned,
                            material_submittal_approved_actual: task.material_submittal_approved_actual,
                            po_issuance: task.po_issuance_planned,
                            po_issuance_actual: task.po_issuance_actual,
                            // Repeat request milestones
                            prices_confirm: task.prices_confirm_planned,
                            prices_confirm_actual: task.prices_confirm_actual
                        }
                    }));
                    
                    console.log('Processed tasks:', this.cache.tasks);
                    return this.cache.tasks;
                } catch (error) {
                    console.error('Error loading tasks:', error);
                    throw error;
                }
            }

            async saveTask(taskData) {
                try {
                    // First try with all columns, fallback to basic columns if new ones don't exist
                    const dbTask = {
                        owner_id: taskData.owner_id,
                        pr_no: taskData.pr_no,
                        project: taskData.project,
                        type: taskData.type,
                        is_permanent: taskData.is_permanent,
                        assignment_date: taskData.assignment_date,
                        status: taskData.status,
                        // Weight fields
                        task_weight: taskData.task_weight || 5,
                        weight_set_by: taskData.weight_set_by,
                        weight_modified_by: taskData.weight_modified_by,
                        weight_modified_at: taskData.weight_modified_at,
                        weight_modification_reason: taskData.weight_modification_reason,
                        // Score fields
                        performance_score: taskData.performance_score,
                        last_score_calculation: taskData.last_score_calculation,
                        // New request milestones
                        vendor_list_planned: taskData.milestones?.vendor_list || null,
                        vendor_list_actual: taskData.milestones?.vendor_list_actual || null,
                        rfq_float_planned: taskData.milestones?.rfq_float || null,
                        rfq_float_actual: taskData.milestones?.rfq_float_actual || null,
                        target_prices_planned: taskData.milestones?.target_prices || null,
                        target_prices_actual: taskData.milestones?.target_prices_actual || null,
                        comparison_planned: taskData.milestones?.comparison || null,
                        comparison_actual: taskData.milestones?.comparison_actual || null,
                        // Material submittal milestones (for permanent PRs)
                        material_submittal_required: taskData.milestones?.material_submittal_required || null,
                        material_submittal_submitted_planned: taskData.milestones?.material_submittal_submitted || null,
                        material_submittal_submitted_actual: taskData.milestones?.material_submittal_submitted_actual || null,
                        material_submittal_approved_planned: taskData.milestones?.material_submittal_approved || null,
                        material_submittal_approved_actual: taskData.milestones?.material_submittal_approved_actual || null,
                        po_issuance_planned: taskData.milestones?.po_issuance || null,
                        po_issuance_actual: taskData.milestones?.po_issuance_actual || null,
                        // Repeat request milestones
                        prices_confirm_planned: taskData.milestones?.prices_confirm || null,
                        prices_confirm_actual: taskData.milestones?.prices_confirm_actual || null,
                        completion_date: taskData.completion_date || null
                    };

                    // Add new columns if they exist
                    if (taskData.current_stage !== undefined) {
                        dbTask.current_stage = taskData.current_stage;
                    }
                    if (taskData.action_by !== undefined) {
                        dbTask.action_by = taskData.action_by;
                    }
                    if (taskData.cancellation_date !== undefined) {
                        dbTask.cancellation_date = taskData.cancellation_date;
                    }
                    if (taskData.task_weight !== undefined) {
                        dbTask.task_weight = taskData.task_weight;
                    }
                    if (taskData.weight_set_by !== undefined) {
                        dbTask.weight_set_by = taskData.weight_set_by;
                    }
                    if (taskData.weight_modified_by !== undefined) {
                        dbTask.weight_modified_by = taskData.weight_modified_by;
                    }
                    if (taskData.weight_modified_at !== undefined) {
                        dbTask.weight_modified_at = taskData.weight_modified_at;
                    }
                    if (taskData.weight_modification_reason !== undefined) {
                        dbTask.weight_modification_reason = taskData.weight_modification_reason;
                    }
                    if (taskData.performance_score !== undefined) {
                        dbTask.performance_score = taskData.performance_score;
                    }
                    if (taskData.last_score_calculation !== undefined) {
                        dbTask.last_score_calculation = taskData.last_score_calculation;
                    }
                    if (taskData.remarks !== undefined) {
                        dbTask.remarks = JSON.stringify(taskData.remarks); // Store as JSON string
                    }
                    if (taskData.last_updated !== undefined) {
                        dbTask.last_updated = taskData.last_updated;
                    }

                    // Ensure proper data types for dates
                    if (dbTask.assignment_date && typeof dbTask.assignment_date === 'string') {
                        dbTask.assignment_date = dbTask.assignment_date;
                    }
                    if (dbTask.completion_date && typeof dbTask.completion_date === 'string') {
                        dbTask.completion_date = dbTask.completion_date;
                    }
                    if (dbTask.cancellation_date && typeof dbTask.cancellation_date === 'string') {
                        dbTask.cancellation_date = dbTask.cancellation_date;
                    }

                    console.log('Attempting to save task with data:', JSON.stringify(dbTask, null, 2));

                    let result;
                    if (taskData.id) {
                        // Update existing task
                        const { data, error } = await supabaseClient
                            .from('pt_tasks')
                            .update(dbTask)
                            .eq('id', taskData.id);
                        result = { data, error };
                    } else {
                        // Insert new task
                        const { data, error } = await supabaseClient
                            .from('pt_tasks')
                            .insert(dbTask)
                            .select();
                        result = { data, error };
                    }
                    
                    if (result.error) {
                        console.error('Database error details:', JSON.stringify(result.error, null, 2));
                        console.error('Error message:', result.error.message);
                        console.error('Error code:', result.error.code);
                        console.error('Error details:', result.error.details);
                        console.error('Error hint:', result.error.hint);
                        throw result.error;
                    }
                    
                    // Reload tasks to update cache
                    await this.loadTasks();
                    return result.data ? result.data[0] : { id: taskData.id };
                } catch (error) {
                    console.error('Error saving task:', JSON.stringify(error, null, 2));
                    console.error('Task data being saved:', JSON.stringify(taskData, null, 2));
                    console.error('Database operation failed');
                    throw error;
                }
            }

            async saveUser(userData) {
                try {
                    let result;
                    const dbUser = {
                        username: userData.username,
                        password: userData.password,
                        name: userData.name,
                        role: userData.role
                    };

                    if (userData.id) {
                        // Update existing user
                        const { data, error } = await supabaseClient
                            .from('pt_users')
                            .update(dbUser)
                            .eq('id', userData.id)
                            .select();
                        result = { data, error };
                    } else {
                        // Insert new user
                        dbUser.id = Date.now().toString();
                        const { data, error } = await supabaseClient
                            .from('pt_users')
                            .insert(dbUser)
                            .select();
                        result = { data, error };
                    }
                    
                    if (result.error) throw result.error;

                    // Update reporting relationships
                    if (userData.reports_to && userData.reports_to.length > 0) {
                        const userId = userData.id || result.data[0].id;
                        await supabaseClient.rpc('update_user_reports', {
                            p_user_id: userId,
                            p_reports_to_ids: userData.reports_to
                        });
                    }
                    
                    // Reload users to update cache
                    await this.loadUsers();
                    return result.data[0];
                } catch (error) {
                    console.error('Error saving user:', error);
                    throw error;
                }
            }

            async deleteUser(userId) {
                try {
                    // Delete user reports first
                    await supabaseClient
                        .from('pt_user_reports')
                        .delete()
                        .or(`user_id.eq.${userId},reports_to_id.eq.${userId}`);
                    
                    // Delete user
                    const { error } = await supabaseClient
                        .from('pt_users')
                        .delete()
                        .eq('id', userId);
                    
                    if (error) throw error;
                    
                    // Reload users to update cache
                    await this.loadUsers();
                } catch (error) {
                    console.error('Error deleting user:', error);
                    throw error;
                }
            }

            getUsers() {
                return this.cache.users;
            }

            getTasks() {
                return this.cache.tasks;
            }

            getProjects() {
                return this.cache.projects;
            }
        }

        const db = new SupabaseDB();
        let currentUser = null;

        /**
         * ------------------------------------------------------------------
         * AUTHENTICATION & HIERARCHY LOGIC
         * ------------------------------------------------------------------
         */
        const AuthService = {
            login: async (username, password) => {
                try {
                    const user = await db.authenticate(username, password);
                    if (user) {
                        currentUser = user;
                        // Load initial data
                        await Promise.all([
                            db.loadUsers(),
                            db.loadTasks()
                        ]);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Login error:', error);
                    return false;
                }
            },
            logout: () => {
                currentUser = null;
                Render.login();
            },
            // Recursive function to get all user IDs under a specific user
            getSubordinates: (userId) => {
                const allUsers = db.getUsers();
                let subordinates = [];
                
                // Direct reports
                let directReports = allUsers.filter(u => {
                    if (u.reports_to && Array.isArray(u.reports_to)) {
                        return u.reports_to.some(report => report.id === userId);
                    }
                    return false;
                });

                subordinates = [...directReports];

                // Recursively get reports of reports
                directReports.forEach(sub => {
                    subordinates = [...subordinates, ...AuthService.getSubordinates(sub.id)];
                });

                return subordinates;
            },
            // Check if current user is a manager of the target user
            isManagerOf: (managerId, targetUserId) => {
                const allUsers = db.getUsers();
                const target = allUsers.find(u => u.id === targetUserId);
                if (!target || !target.reports_to) return false;
                return target.reports_to.some(report => report.id === managerId);
            },

            // Check if two users share the same manager
            sharesSameManager: (userId1, userId2) => {
                const allUsers = db.getUsers();
                const user1 = allUsers.find(u => u.id === userId1);
                const user2 = allUsers.find(u => u.id === userId2);
                
                if (!user1 || !user2 || !user1.reports_to || !user2.reports_to) return false;
                
                const user1ManagerIds = user1.reports_to.map(m => m.id);
                const user2ManagerIds = user2.reports_to.map(m => m.id);
                
                return user1ManagerIds.some(m => user2ManagerIds.includes(m));
            },

            // Check if user is a direct manager
            isDirectManager: (managerId, targetUserId) => {
                return AuthService.isManagerOf(managerId, targetUserId);
            },

            // Check if user is a direct report
            isDirectReport: (managerId, reportId) => {
                return AuthService.isManagerOf(managerId, reportId);
            },

            // Check if two managers share the same director
            sharesSameDirector: (managerId1, managerId2) => {
                return AuthService.sharesSameManager(managerId1, managerId2);
            }
        };

        /**
         * ------------------------------------------------------------------
         * DATA SERVICE - FILTERS AND AGGREGATIONS
         * ------------------------------------------------------------------
         */
        const DataService = {
            getMyTeamTasks() {
                const allTasks = db.getTasks();
                const allUsers = db.getUsers();
                
                console.log('All tasks from cache:', allTasks);
                console.log('All users from cache:', allUsers);
                console.log('Current user:', currentUser);
                
                if (currentUser.role === 'engineer') {
                    // Engineers see only their own tasks
                    const myTasks = allTasks.filter(t => t.owner_id === currentUser.id);
                    console.log('Engineer tasks:', myTasks);
                    return myTasks;
                } else if (currentUser.role === 'manager') {
                    // Managers only see tasks of their DIRECT engineer reports
                    const directEngineerReports = allUsers.filter(u => 
                        u.role === "engineer" && 
                        u.reports_to && 
                        u.reports_to.some(report => report.id === currentUser.id)
                    );
                    console.log('Direct engineer reports:', directEngineerReports);
                    const engineerIds = directEngineerReports.map(u => u.id);
                    engineerIds.push(currentUser.id); // Include own tasks
                    const managerTasks = allTasks.filter(t => engineerIds.includes(t.owner_id));
                    console.log('Manager tasks:', managerTasks);
                    return managerTasks;
                } else if (currentUser.role === 'admin') {
                    // Admins see ALL tasks in the system
                    console.log('Admin sees all tasks:', allTasks);
                    return allTasks;
                } else {
                    // Directors, VPs see all tasks under their hierarchy
                    const teamIds = AuthService.getSubordinates(currentUser.id).map(u => u.id);
                    teamIds.push(currentUser.id); // Include own tasks
                    console.log('Team IDs for hierarchy:', teamIds);
                    const hierarchyTasks = allTasks.filter(t => teamIds.includes(t.owner_id));
                    console.log('Hierarchy tasks:', hierarchyTasks);
                    return hierarchyTasks;
                }
            },
            getDashboardMetrics() {
                const teamTasks = this.getMyTeamTasks();
                console.log('Team tasks for metrics:', teamTasks);
                
                const metrics = {
                    total: teamTasks.length,
                    pending: teamTasks.filter(t => t.status.includes('Pending')).length,
                    completed: teamTasks.filter(t => t.status === 'Closed').length,
                    waitingApproval: teamTasks.filter(t => t.status === 'Pending Approval').length,
                    onHold: teamTasks.filter(t => t.status === 'On Hold').length,
                    cancelled: teamTasks.filter(t => t.status === 'Cancelled').length,
                    permanent: teamTasks.filter(t => t.is_permanent).length,
                    nonPermanent: teamTasks.filter(t => !t.is_permanent).length,
                    newPr: teamTasks.filter(t => t.type === 'new').length,
                    repeatPr: teamTasks.filter(t => t.type === 'repeat').length,
                    userScore: ScoringService.calculateUserScore(currentUser.id),
                    milestoneBottlenecks: {}
                };

                console.log('Dashboard metrics:', metrics);

                // Calculate milestone bottlenecks
                const pendingTasks = teamTasks.filter(t => t.status.includes('Pending'));
                pendingTasks.forEach(task => {
                    const m = task.milestones;
                    let stage = "Complete";
                    
                    if (task.type === 'new') {
                        if (!m.vendor_list) stage = "Vendor List";
                        else if (!m.rfq_float) stage = "RFQ Float";
                        else if (!m.target_prices) stage = "Target Prices";
                        else if (!m.comparison) stage = "Comparison";
                        else if (!m.po_issuance) stage = "PO Issue";
                    } else {
                        if (!m.prices_confirm) stage = "Price Confirm";
                        else if (!m.comparison) stage = "Comparison";
                        else if (!m.po_issuance) stage = "PO Issue";
                    }
                    
                    metrics.milestoneBottlenecks[stage] = (metrics.milestoneBottlenecks[stage] || 0) + 1;
                });

                return metrics;
            }
        };

        /**
         * ------------------------------------------------------------------
         * RENDER SERVICE - UI GENERATION
         * ------------------------------------------------------------------
         */
        const Render = {
            init: () => {
                if (!currentUser) {
                    Render.login();
                } else {
                    Render.dashboard();
                }
            },

            showLoading: () => {
                document.getElementById('app').innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-slate-200">
                        <div class="text-center">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p class="text-slate-600">Connecting to database...</p>
                        </div>
                    </div>
                `;
            },

            layout: (content) => {
                return `
                    <div class="flex h-full">
                        <!-- Sidebar -->
                        <div class="w-64 bg-slate-800 text-white flex flex-col shadow-lg">
                            <div class="p-6 border-b border-slate-700">
                                <div class="flex items-center">
                                    <i class="fas fa-cubes text-blue-400 text-2xl mr-3"></i>
                                    <div>
                                        <h1 class="text-xl font-bold">ProcureTrack</h1>
                                        <p class="text-xs text-slate-400">v2.0 - Supabase</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-4 border-b border-slate-700">
                                <div class="text-sm text-slate-300">Logged in as:</div>
                                <div class="font-semibold">${currentUser.name}</div>
                                <div class="text-xs text-blue-400 capitalize">${currentUser.role}</div>
                            </div>
                            
                            <nav class="flex-1 p-4">
                                <ul class="space-y-2">
                                    <li><a href="#" onclick="Render.dashboard()" class="flex items-center py-2 px-3 rounded text-slate-300 hover:bg-slate-700 hover:text-white transition"><i class="fas fa-chart-line mr-3"></i>Dashboard</a></li>
                                    <li>
                                        <div class="text-slate-400 text-xs uppercase tracking-wider mb-2">Tasks</div>
                                        <ul class="ml-4 space-y-1">
                                            <li><a href="#" onclick="Render.taskList()" class="flex items-center py-2 px-3 rounded text-slate-300 hover:bg-slate-700 hover:text-white transition"><i class="fas fa-receipt mr-3"></i>PR Tasks</a></li>
                                        </ul>
                                    </li>
                                    <li><a href="#" onclick="Render.taskTracking()" class="flex items-center py-2 px-3 rounded text-slate-300 hover:bg-slate-700 hover:text-white transition"><i class="fas fa-project-diagram mr-3"></i>Task Tracking</a></li>
                                    ${currentUser.role === 'admin' ? '<li><a href="#" onclick="Render.adminPanel()" class="flex items-center py-2 px-3 rounded text-slate-300 hover:bg-slate-700 hover:text-white transition"><i class="fas fa-users-cog mr-3"></i>Admin Panel</a></li>' : ''}
                                </ul>
                            </nav>
                            
                            <div class="p-4 border-t border-slate-700">
                                <button onclick="AuthService.logout()" class="w-full flex items-center justify-center py-2 px-3 rounded bg-red-600 text-white hover:bg-red-700 transition">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                        
                        <!-- Main Content -->
                        <div class="flex-1 overflow-y-auto bg-gray-50">
                            <div class="p-8">
                                <div class="mb-4">
                                    <div class="text-green-600 text-sm flex items-center">
                                        <i class="fas fa-database mr-2"></i>
                                        Connected to Supabase Database
                                    </div>
                                </div>
                                ${content}
                            </div>
                        </div>
                    </div>
                `;
            },

            login: () => {
                document.getElementById('app').innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-slate-200">
                        <div class="bg-white p-8 rounded-lg shadow-xl w-96 fade-in">
                            <div class="text-center mb-6">
                                <i class="fas fa-cubes text-4xl text-blue-600 mb-2"></i>
                                <h1 class="text-2xl font-bold text-slate-700">ProcureTrack</h1>
                                <p class="text-xs text-slate-500 mt-1">Supabase Database</p>
                            </div>
                            <form onsubmit="handleLogin(event)">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-1">Username</label>
                                    <input type="text" id="username" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" required>
                                </div>
                                <div class="mb-6">
                                    <label class="block text-sm font-medium mb-1">Password</label>
                                    <input type="password" id="password" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" required>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition font-medium">Login</button>
                            </form>
                            <div id="login-error" class="mt-4 text-red-600 text-sm text-center hidden"></div>
                        </div>
                    </div>
                `;
            },

            dashboard: () => {
                const metrics = DataService.getDashboardMetrics();
                const html = `
                    <div class="mb-8 flex justify-between items-start">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800 mb-2">Dashboard</h2>
                            <p class="text-slate-600">Welcome back, ${currentUser.name}! Here's your team overview.</p>
                        </div>
                        <button onclick="ScoringService.updateAllScores().then(() => { Render.dashboard(); alert('ðŸ“Š Scores updated successfully!\\n\\nAll task performance scores have been recalculated.'); })" 
                                class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2 transition">
                            <i class="fas fa-calculator"></i> Update Scores
                        </button>
                    </div>

                    <!-- Key Metrics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-4 mb-8">
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-500">
                            <div class="text-slate-500 text-xs">Total PRs</div>
                            <div class="text-2xl font-bold text-slate-800">${metrics.total}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-500">
                            <div class="text-slate-500 text-xs">Completed</div>
                            <div class="text-2xl font-bold text-slate-800">${metrics.completed}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-yellow-500">
                            <div class="text-slate-500 text-xs">Pending</div>
                            <div class="text-2xl font-bold text-slate-800">${metrics.pending}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-orange-500">
                            <div class="text-slate-500 text-xs">Approval</div>
                            <div class="text-2xl font-bold text-slate-800">${metrics.waitingApproval}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-gray-500">
                            <div class="text-slate-500 text-xs">On Hold</div>
                            <div class="text-2xl font-bold text-slate-800">${metrics.onHold}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-red-500">
                            <div class="text-slate-500 text-xs">Cancelled</div>
                            <div class="text-2xl font-bold text-slate-800">${metrics.cancelled}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-purple-500">
                            <div class="text-slate-500 text-xs">Your Score</div>
                            <div class="text-2xl font-bold ${metrics.userScore >= 8 ? 'text-green-600' : metrics.userScore >= 6 ? 'text-yellow-600' : 'text-red-600'}">${metrics.userScore.toFixed(1)}/10</div>
                        </div>
                    </div>

                    <!-- Charts Area -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Pending Milestones (Bottleneck) -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-4">Pending Bottlenecks (Timeline)</h3>
                            <canvas id="bottleneckChart"></canvas>
                        </div>
                        
                        <!-- Types Breakdown -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-4">PR Types Breakdown</h3>
                            <div class="flex h-64 justify-center">
                                <canvas id="typeChart"></canvas>
                            </div>
                        </div>

                        <!-- Team Performance -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-4">Team Performance</h3>
                            <div id="teamScores" class="space-y-3 max-h-64 overflow-y-auto">
                                <!-- Team scores will be populated here -->
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('app').innerHTML = Render.layout(html);

                // Render Charts using Chart.js
                setTimeout(() => {
                    // Bottleneck Bar Chart
                    const bnLabels = Object.keys(metrics.milestoneBottlenecks);
                    const bnData = Object.values(metrics.milestoneBottlenecks);
                    
                    new Chart(document.getElementById('bottleneckChart'), {
                        type: 'bar',
                        data: {
                            labels: bnLabels.length ? bnLabels : ['No Pending Tasks'],
                            datasets: [{
                                label: 'PRs Stuck at Stage',
                                data: bnData.length ? bnData : [0],
                                backgroundColor: '#3b82f6',
                                borderRadius: 4
                            }]
                        },
                        options: { responsive: true, scales: { y: { beginAtZero: true, stepSize: 1 } } }
                    });

                    // Pie Chart
                    new Chart(document.getElementById('typeChart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['New PR', 'Repeat PR', 'Permanent', 'Non-Perm'],
                            datasets: [{
                                data: [metrics.newPr, metrics.repeatPr, metrics.permanent, metrics.nonPermanent],
                                backgroundColor: ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b']
                            }]
                        },
                        options: { responsive: true }
                    });
                }, 100);

                // Populate team scores
                setTimeout(() => {
                    Render.populateTeamScores();
                }, 200);

                // Run score calculation 
                setTimeout(() => {
                    ScoringService.updateAllScores();
                }, 300);
            },

            populateTeamScores: () => {
                const users = db.getUsers();
                const teamScoresContainer = document.getElementById('teamScores');
                
                if (!teamScoresContainer) return;

                // Get visible colleagues based on current user role
                let visibleColleagues = [];
                
                switch(currentUser.role) {
                    case 'engineer':
                        // Can see other engineers in same team + their manager
                        visibleColleagues = users.filter(u => 
                            (u.role === 'engineer' && AuthService.sharesSameManager(currentUser.id, u.id)) ||
                            AuthService.isDirectManager(u.id, currentUser.id) ||
                            u.id === currentUser.id
                        );
                        break;
                        
                    case 'manager':
                        // Can see their direct reports + peer managers + their director
                        visibleColleagues = users.filter(u => 
                            AuthService.isDirectReport(currentUser.id, u.id) ||
                            (u.role === 'manager' && AuthService.sharesSameDirector(currentUser.id, u.id)) ||
                            AuthService.isDirectManager(u.id, currentUser.id) ||
                            u.id === currentUser.id
                        );
                        break;
                        
                    case 'director':
                    case 'vp':
                    case 'admin':
                        // Can see everyone
                        visibleColleagues = users;
                        break;
                        
                    default:
                        visibleColleagues = [currentUser];
                }

                // Calculate scores for visible colleagues
                const colleagueScores = visibleColleagues.map(user => ({
                    ...user,
                    score: ScoringService.calculateUserScore(user.id),
                    taskCount: db.getTasks().filter(t => t.owner_id === user.id).length
                })).sort((a, b) => b.score - a.score);

                // Populate the team scores
                teamScoresContainer.innerHTML = colleagueScores.map(colleague => `
                    <div class="flex justify-between items-center p-3 border rounded ${colleague.id === currentUser.id ? 'bg-blue-50 border-blue-200' : 'hover:bg-gray-50'}">
                        <div>
                            <div class="font-medium ${colleague.id === currentUser.id ? 'text-blue-700' : ''}">${colleague.name} ${colleague.id === currentUser.id ? '(You)' : ''}</div>
                            <div class="text-sm text-gray-500">${colleague.role} â€¢ ${colleague.taskCount} tasks</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${colleague.score >= 8 ? 'text-green-600' : colleague.score >= 6 ? 'text-yellow-600' : 'text-red-600'}">${colleague.score.toFixed(1)}/10</div>
                            <div class="text-xs text-gray-400">Performance</div>
                        </div>
                    </div>
                `).join('');
            },

            taskList: () => {
                const tasks = DataService.getMyTeamTasks();
                const users = db.getUsers();
                
                // Calculate ongoing performance scores for display
                tasks.forEach(task => {
                    if (task.status !== 'Closed' && task.status !== 'Cancelled') {
                        task._displayScore = ScoringService.calculateOngoingTaskScore(task);
                    }
                });
                
                const html = `
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">PR Task Management</h2>
                            <div class="mt-2 flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="showClosed" onchange="toggleClosedTasks()" class="mr-2">
                                    <span class="text-sm text-slate-600">Show Closed Tasks</span>
                                </label>
                            </div>
                        </div>
                        ${['engineer', 'manager', 'director', 'vp', 'admin'].includes(currentUser.role) ? 
                          `<button onclick="Modal.openTaskModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow flex items-center gap-2">
                             <i class="fas fa-plus"></i> Add PR Task
                           </button>` : ''}
                    </div>

                    <div id="taskTableContainer" class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-slate-600 font-bold border-b">
                                <tr>
                                    <th class="p-4">PR No.</th>
                                    <th class="p-4">Type</th>
                                    <th class="p-4">Owner</th>
                                    <th class="p-4">Project</th>
                                    <th class="p-4">Assigned</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4 text-center">Weight</th>
                                    <th class="p-4 text-center">Performance</th>
                                    <th class="p-4 text-center">Current Stage</th>
                                    <th class="p-4 text-center">Action By</th>
                                    <th class="p-4 text-center">Remarks</th>
                                    <th class="p-4 text-center">Last Updated</th>
                                    <th class="p-4">Action</th>
                                </tr>
                            </thead>
                            <tbody id="taskTableBody" class="divide-y divide-slate-100">
                                ${Render.renderTaskRows(tasks, users)}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('app').innerHTML = Render.layout(html);
            },

            renderTaskRows: (tasks, users, showClosed = false) => {
                const filteredTasks = showClosed ? tasks : tasks.filter(t => t.status !== 'Closed');
                
                // Debug: Log actual task statuses
                console.log('Task statuses:', tasks.map(t => ({ pr_no: t.pr_no, status: t.status, type: typeof t.status })));
                
                return filteredTasks.map(t => {
                    const ownerName = users.find(u => u.id === t.owner_id)?.name || 'Unknown';
                    let stage = "Complete";
                    let statusColor = 'bg-gray-100 text-gray-700';

                    console.log(`Task ${t.pr_no}: status="${t.status}", current_stage="${t.current_stage}", action_by="${t.action_by}"`);

                    if(t.status === 'Pending') statusColor = 'bg-yellow-100 text-yellow-700';
                    else if(t.status === 'Closed') statusColor = 'bg-green-100 text-green-700';
                    else if(t.status === 'Pending Approval') statusColor = 'bg-orange-100 text-orange-700';
                    else if(t.status === 'On Hold') statusColor = 'bg-gray-100 text-gray-700';
                    else if(t.status === 'Cancelled') statusColor = 'bg-red-100 text-red-700';

                    // Use current_stage from database or calculate from milestones
                    if(t.status === 'Closed') {
                        stage = "Complete";
                    } else if(t.status === 'Cancelled') {
                        stage = "Cancelled";
                    } else if(t.status === 'On Hold') {
                        stage = "On Hold";
                    } else {
                        // Convert database stage value to display text
                        const stageMap = {
                            vendor_list: "Vendor List",
                            rfq_float: "RFQ Float", 
                            target_prices: "Target Prices",
                            comparison: "Comparison",
                            po_issuance: "PO Issue",
                            prices_confirm: "Price Confirm"
                        };
                        stage = stageMap[t.current_stage] || "Unknown Stage";
                    }
                    
                    console.log(`Final stage for ${t.pr_no}: ${stage}`);
                    
                    // Check permissions for actions
                    const canApprove = t.status === 'Pending Approval' && AuthService.isManagerOf(currentUser.id, t.owner_id);
                    const canEdit = currentUser.role === 'admin' || 
                                   (currentUser.role === 'engineer' && t.owner_id === currentUser.id && t.status !== 'Closed') ||
                                   (currentUser.role !== 'engineer' && t.status !== 'Closed');

                    return `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="p-4 font-medium text-blue-600">${t.pr_no}</td>
                        <td class="p-4"><span class="px-2 py-1 rounded text-xs ${t.type === 'new' ? 'bg-purple-100 text-purple-700' : 'bg-teal-100 text-teal-700'}">${t.type.toUpperCase()}</span></td>
                        <td class="p-4 text-slate-600">${ownerName}</td>
                        <td class="p-4 text-slate-600">${t.project}</td>
                        <td class="p-4 text-slate-500">${t.assignment_date}</td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${statusColor}">
                                ${t.status}
                            </span>
                        </td>
                        <td class="p-4 text-center">
                            <div class="flex items-center justify-center space-x-1">
                                <span class="px-2 py-1 rounded text-xs font-semibold ${t.task_weight >= 8 ? 'bg-red-100 text-red-700' : t.task_weight >= 6 ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700'}">${t.task_weight || 5}/10</span>
                                ${(currentUser.role === 'manager' || currentUser.role === 'director' || currentUser.role === 'vp' || currentUser.role === 'admin') && t.status !== 'Closed' && t.status !== 'Cancelled' ? 
                                    `<button onclick="Modal.openWeightOverrideModal(${t.id})" class="text-orange-500 hover:text-orange-700 text-xs" title="Modify Weight"><i class="fas fa-edit"></i></button>` : ''}
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            ${(() => {
                                if (t.status === 'Closed' && t.performance_score) {
                                    return `<span class="px-2 py-1 rounded text-xs font-semibold ${t.performance_score >= 8 ? 'bg-green-100 text-green-700' : t.performance_score >= 6 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">${t.performance_score.toFixed(1)}/10</span>`;
                                } else if (t.status === 'Closed') {
                                    return '<span class="text-xs text-slate-400">Not calculated</span>';
                                } else if (['Cancelled', 'On Hold'].includes(t.status)) {
                                    return '<span class="text-xs text-slate-400">N/A</span>';
                                } else {
                                    // Use the display score calculated earlier
                                    const score = t._displayScore || 5.0;
                                    return `<span class="px-2 py-1 rounded text-xs font-semibold ${score >= 8 ? 'bg-green-100 text-green-700' : score >= 6 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">${score.toFixed(1)}/10</span>`;
                                }
                            })()}
                        </td>
                        <td class="p-4 text-center">
                            ${['Closed', 'Cancelled', 'On Hold'].includes(t.status) ? 
                                `<span class="text-xs text-slate-500">${stage}</span>` :
                                `<select onchange="updateCurrentStage(${t.id}, this.value)" class="text-xs border rounded px-2 py-1 ${canEdit ? '' : 'bg-gray-100 cursor-not-allowed'}" data-original-stage="${t.current_stage}" ${canEdit ? '' : 'disabled'}>
                                    ${t.type === 'new' ? `
                                        <option value="vendor_list" ${stage === 'Vendor List' ? 'selected' : ''}>Vendor List</option>
                                        <option value="rfq_float" ${stage === 'RFQ Float' ? 'selected' : ''}>RFQ Float</option>
                                        <option value="target_prices" ${stage === 'Target Prices' ? 'selected' : ''}>Target Prices</option>
                                        <option value="comparison" ${stage === 'Comparison' ? 'selected' : ''}>Comparison</option>
                                        <option value="po_issuance" ${stage === 'PO Issue' ? 'selected' : ''}>PO Issue</option>
                                    ` : `
                                        <option value="prices_confirm" ${stage === 'Price Confirm' ? 'selected' : ''}>Price Confirm</option>
                                        <option value="comparison" ${stage === 'Comparison' ? 'selected' : ''}>Comparison</option>
                                        <option value="po_issuance" ${stage === 'PO Issue' ? 'selected' : ''}>PO Issue</option>
                                    `}
                                </select>`
                            }
                        </td>
                        <td class="p-4 text-center">
                            ${['Closed', 'Cancelled'].includes(t.status) ? 
                                `<span class="text-xs text-slate-500">${t.action_by ? t.action_by.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A'}</span>` :
                                (currentUser.role === 'engineer' && t.owner_id === currentUser.id) || 
                                currentUser.role === 'admin' || 
                                ((currentUser.role === 'manager' || currentUser.role === 'director' || currentUser.role === 'vp') && AuthService.isManagerOf(currentUser.id, t.owner_id)) ?
                                `<select onchange="updateActionBy(${t.id}, this.value)" class="text-xs border rounded px-2 py-1 w-full max-w-[120px]">
                                    <option value="">Select...</option>
                                    <option value="proc_eng_buyer" ${t.action_by === 'proc_eng_buyer' ? 'selected' : ''}>Proc Eng./Buyer</option>
                                    <option value="proc_manager" ${t.action_by === 'proc_manager' ? 'selected' : ''}>Proc Manager</option>
                                    <option value="proc_director" ${t.action_by === 'proc_director' ? 'selected' : ''}>Proc Director</option>
                                    <option value="engineering" ${t.action_by === 'engineering' ? 'selected' : ''}>Engineering</option>
                                    <option value="site" ${t.action_by === 'site' ? 'selected' : ''}>Site</option>
                                    <option value="supplier" ${t.action_by === 'supplier' ? 'selected' : ''}>Supplier</option>
                                    <option value="consultant" ${t.action_by === 'consultant' ? 'selected' : ''}>Consultant</option>
                                    <option value="management" ${t.action_by === 'management' ? 'selected' : ''}>Management</option>
                                </select>` :
                                `<span class="text-xs text-slate-500">${t.action_by ? (() => {
                                    const formatted = t.action_by.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                    return formatted;
                                })() : 'Not assigned'}</span>`
                            }
                        </td>
                        <td class="p-4 text-center">
                            ${currentUser.role === 'engineer' && t.owner_id === currentUser.id && !['Closed', 'Cancelled'].includes(t.status) ?
                                `<div class="relative">
                                    <button onclick="Modal.openRemarksModal(${t.id})" class="text-xs px-2 py-1 rounded border hover:bg-gray-50 flex items-center gap-1 ${t.remarks && t.remarks.length > 0 ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-gray-50 text-gray-600 border-gray-200'}" title="Add/View Remarks Timeline">
                                        <i class="fas fa-comment-alt"></i>
                                        ${t.remarks && t.remarks.length > 0 ? `${t.remarks.length} notes` : 'Add note'}
                                    </button>
                                 </div>` :
                                t.remarks && t.remarks.length > 0 ? 
                                    `<button onclick="Modal.viewRemarksModal(${t.id})" class="text-xs px-2 py-1 rounded bg-blue-50 text-blue-700 border border-blue-200 hover:bg-blue-100 flex items-center gap-1" title="View Remarks Timeline">
                                        <i class="fas fa-comment-dots"></i> ${t.remarks.length} notes
                                     </button>` :
                                    `<span class="text-xs text-slate-400">No notes</span>`
                            }
                        </td>
                        <td class="p-4 text-center">
                            ${(() => {
                                const lastUpdated = ScoringService.getLastUpdatedDate(t);
                                const now = new Date();
                                const diffHours = Math.floor((now.getTime() - lastUpdated.getTime()) / (1000 * 60 * 60));
                                const diffDays = Math.floor(diffHours / 24);
                                
                                let timeAgo = '';
                                let colorClass = '';
                                
                                if (diffHours < 1) {
                                    timeAgo = 'Just now';
                                    colorClass = 'text-green-600';
                                } else if (diffHours < 24) {
                                    timeAgo = diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
                                    colorClass = 'text-green-600';
                                } else if (diffDays === 1) {
                                    timeAgo = '1 day ago';
                                    colorClass = 'text-blue-600';
                                } else if (diffDays < 7) {
                                    timeAgo = `${diffDays} days ago`;
                                    colorClass = 'text-blue-600';
                                } else if (diffDays < 30) {
                                    const weeks = Math.floor(diffDays / 7);
                                    timeAgo = weeks === 1 ? '1 week ago' : `${weeks} weeks ago`;
                                    colorClass = 'text-yellow-600';
                                } else {
                                    const months = Math.floor(diffDays / 30);
                                    timeAgo = months === 1 ? '1 month ago' : `${months} months ago`;
                                    colorClass = 'text-red-600';
                                }
                                
                                return `
                                    <div class="text-center">
                                        <div class="text-xs font-medium ${colorClass}">${timeAgo}</div>
                                        <div class="text-xs text-gray-500">${lastUpdated.toLocaleDateString()}</div>
                                    </div>
                                `;
                            })()}
                        </td>
                        <td class="p-4">
                            ${t.status === 'Closed' ? 
                                `<button onclick="Modal.viewTask(${t.id})" class="text-gray-500 hover:text-gray-700 mr-2" title="View Details"><i class="fas fa-eye"></i></button>
                                 ${(currentUser.role === 'manager' || currentUser.role === 'director' || currentUser.role === 'vp' || currentUser.role === 'admin') && AuthService.isManagerOf(currentUser.id, t.owner_id) ? `<button onclick="handleReopenTask(${t.id})" class="text-orange-500 hover:text-orange-700 mr-2" title="Re-open Task"><i class="fas fa-undo"></i></button>` : ''}
                                 ${currentUser.role === 'admin' ? `<button onclick="Modal.editTask(${t.id})" class="text-blue-500 hover:text-blue-700" title="Edit (Admin)"><i class="fas fa-edit"></i></button>` : ''}` :
                            t.status === 'Cancelled' ?
                                `<button onclick="Modal.viewTask(${t.id})" class="text-gray-500 hover:text-gray-700 mr-2" title="View Details"><i class="fas fa-eye"></i></button>
                                 ${(currentUser.role === 'manager' || currentUser.role === 'director' || currentUser.role === 'vp' || currentUser.role === 'admin') && AuthService.isManagerOf(currentUser.id, t.owner_id) ? `<button onclick="handleResumeTask(${t.id})" class="text-green-500 hover:text-green-700" title="Resume Task"><i class="fas fa-play"></i></button>` : ''}` :
                            t.status === 'On Hold' ?
                                `${(currentUser.role === 'manager' || currentUser.role === 'director' || currentUser.role === 'vp' || currentUser.role === 'admin') && AuthService.isManagerOf(currentUser.id, t.owner_id) ? 
                                    `<button onclick="Modal.viewTask(${t.id})" class="text-gray-500 hover:text-gray-700 mr-2" title="View Details"><i class="fas fa-eye"></i></button>
                                     <button onclick="handleResumeTask(${t.id})" class="text-green-500 hover:text-green-700 mr-2" title="Resume Task"><i class="fas fa-play"></i></button>
                                     <button onclick="handleCancelTask(${t.id})" class="text-red-500 hover:text-red-700" title="Cancel Task"><i class="fas fa-times"></i></button>` : 
                                    `<span class="text-gray-400" title="On Hold"><i class="fas fa-pause"></i></span>`}` :
                                currentUser.role === 'engineer' && t.owner_id === currentUser.id ? 
                                    `<button onclick="Modal.openEngineerTaskModal(${t.id})" class="text-blue-500 hover:text-blue-700" title="Update Milestones"><i class="fas fa-calendar-check"></i></button>` :
                                canApprove ?
                                    `<button onclick="handleApprove(${t.id})" class="text-green-500 hover:text-green-700" title="Approve"><i class="fas fa-check"></i></button>` :
                                (currentUser.role === 'manager' || currentUser.role === 'director' || currentUser.role === 'vp' || currentUser.role === 'admin') && AuthService.isManagerOf(currentUser.id, t.owner_id) ?
                                    `<button onclick="Modal.viewTask(${t.id})" class="text-gray-500 hover:text-gray-700 mr-2" title="View Details"><i class="fas fa-eye"></i></button>
                                     <button onclick="Modal.openReassignModal(${t.id})" class="text-purple-500 hover:text-purple-700 mr-2" title="Reassign Task"><i class="fas fa-user-edit"></i></button>
                                     <button onclick="handleCompleteTask(${t.id})" class="text-green-500 hover:text-green-700 mr-2" title="Mark Complete"><i class="fas fa-check-circle"></i></button>
                                     <button onclick="handleHoldTask(${t.id})" class="text-yellow-500 hover:text-yellow-700 mr-2" title="Hold Task"><i class="fas fa-pause"></i></button>
                                     <button onclick="handleCancelTask(${t.id})" class="text-red-500 hover:text-red-700" title="Cancel Task"><i class="fas fa-times"></i></button>` :
                                canEdit ?
                                    `<button onclick="Modal.editTask(${t.id})" class="text-blue-500 hover:text-blue-700" title="Edit"><i class="fas fa-edit"></i></button>` :
                                    `<span class="text-gray-400" title="No permission"><i class="fas fa-lock"></i></span>`
                            }
                        </td>
                    </tr>
                    `;
                }).join('');
            },

            taskTracking: () => {
                const tasks = DataService.getMyTeamTasks();
                const users = db.getUsers();
                
                const html = `
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Task Tracking - Gantt Chart</h2>
                        <p class="text-slate-600">Milestone timeline view for PR tasks</p>
                        
                        <div class="mt-4 flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="showCompletedTasks" onchange="refreshGanttChart()" class="mr-2">
                                <span class="text-sm text-slate-600">Show Completed Tasks</span>
                            </label>
                            <select id="taskFilter" onchange="refreshGanttChart()" class="text-sm border rounded px-3 py-1">
                                <option value="all">All Tasks</option>
                                <option value="new">New PRs Only</option>
                                <option value="repeat">Repeat PRs Only</option>
                            </select>
                            <div class="flex items-center space-x-2">
                                <label class="text-sm text-slate-600">Time Scale:</label>
                                <select id="timeScale" onchange="refreshGanttChart()" class="text-sm border rounded px-3 py-1">
                                    <option value="days">Days</option>
                                    <option value="weeks">Weeks</option>
                                    <option value="months">Months</option>
                                    <option value="quarters">Quarters</option>
                                    <option value="semiannual">Semi-Annual</option>
                                    <option value="annual">Annual</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div id="gantt-container" class="w-full">
                            <div id="gantt-chart" class="overflow-x-auto"></div>
                        </div>
                    </div>
                `;
                
                document.getElementById('app').innerHTML = Render.layout(html);
                
                // Initialize Gantt chart
                setTimeout(() => {
                    Render.initGanttChart(tasks, users);
                }, 100);
            },

            initGanttChart: (tasks, users) => {
                const container = document.getElementById('gantt-chart');
                if (!container) return;

                // Get settings
                const showCompleted = document.getElementById('showCompletedTasks')?.checked || false;
                const taskFilter = document.getElementById('taskFilter')?.value || 'all';
                const timeScale = document.getElementById('timeScale')?.value || 'days';
                
                let filteredTasks = tasks.filter(t => {
                    if (!showCompleted && t.status === 'Closed') return false;
                    if (taskFilter !== 'all' && t.type !== taskFilter) return false;
                    return true;
                });

                if (filteredTasks.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-slate-500">No tasks to display</div>';
                    return;
                }

                // Calculate date range for timeline
                const allDates = [];
                filteredTasks.forEach(task => {
                    if (task.assignment_date) allDates.push(new Date(task.assignment_date));
                    Object.values(task.milestones).forEach(date => {
                        if (date && date !== null) allDates.push(new Date(date));
                    });
                });

                if (allDates.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-slate-500">No milestone dates available</div>';
                    return;
                }

                const minDate = new Date(Math.min(...allDates));
                const maxDate = new Date(Math.max(...allDates));
                
                // Add buffer based on time scale
                const bufferInfo = Render.getTimeScaleBuffer(timeScale);
                minDate.setDate(minDate.getDate() - bufferInfo.bufferDays);
                maxDate.setDate(maxDate.getDate() + bufferInfo.bufferDays);

                // Generate timeline based on time scale
                const timeline = Render.generateTimeline(minDate, maxDate, timeScale);
                const ganttHTML = Render.generateGanttHTML(filteredTasks, users, timeline, minDate, maxDate, timeScale);
                
                container.innerHTML = ganttHTML;
            },

            getTimeScaleBuffer: (timeScale) => {
                const buffers = {
                    days: { bufferDays: 7 },
                    weeks: { bufferDays: 14 },
                    months: { bufferDays: 30 },
                    quarters: { bufferDays: 45 },
                    semiannual: { bufferDays: 60 },
                    annual: { bufferDays: 90 }
                };
                return buffers[timeScale] || buffers.days;
            },

            generateTimeline: (startDate, endDate, timeScale = 'days') => {
                const timeline = [];
                
                switch (timeScale) {
                    case 'days':
                        return Render.generateDayTimeline(startDate, endDate);
                    case 'weeks':
                        return Render.generateWeekTimeline(startDate, endDate);
                    case 'months':
                        return Render.generateMonthTimeline(startDate, endDate);
                    case 'quarters':
                        return Render.generateQuarterTimeline(startDate, endDate);
                    case 'semiannual':
                        return Render.generateSemiAnnualTimeline(startDate, endDate);
                    case 'annual':
                        return Render.generateAnnualTimeline(startDate, endDate);
                    default:
                        return Render.generateDayTimeline(startDate, endDate);
                }
            },

            generateDayTimeline: (startDate, endDate) => {
                const timeline = [];
                const current = new Date(startDate);
                
                while (current <= endDate) {
                    timeline.push({
                        date: new Date(current),
                        dateStr: current.toISOString().split('T')[0],
                        displayText: current.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                        subText: current.toLocaleDateString('en-US', { weekday: 'short' }),
                        isWeekend: current.getDay() === 0 || current.getDay() === 6,
                        unit: 'day'
                    });
                    current.setDate(current.getDate() + 1);
                }
                return timeline;
            },

            generateWeekTimeline: (startDate, endDate) => {
                const timeline = [];
                const current = new Date(startDate);
                
                // Start from Monday of the week containing startDate
                current.setDate(current.getDate() - current.getDay() + 1);
                
                while (current <= endDate) {
                    const weekEnd = new Date(current);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    
                    timeline.push({
                        date: new Date(current),
                        dateStr: current.toISOString().split('T')[0],
                        displayText: `Week ${Render.getWeekNumber(current)}`,
                        subText: current.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                        endDate: weekEnd,
                        unit: 'week'
                    });
                    current.setDate(current.getDate() + 7);
                }
                return timeline;
            },

            generateMonthTimeline: (startDate, endDate) => {
                const timeline = [];
                const current = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
                
                while (current <= endDate) {
                    timeline.push({
                        date: new Date(current),
                        dateStr: current.toISOString().split('T')[0],
                        displayText: current.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
                        subText: current.getFullYear().toString(),
                        unit: 'month'
                    });
                    current.setMonth(current.getMonth() + 1);
                }
                return timeline;
            },

            generateQuarterTimeline: (startDate, endDate) => {
                const timeline = [];
                const current = new Date(startDate.getFullYear(), Math.floor(startDate.getMonth() / 3) * 3, 1);
                
                while (current <= endDate) {
                    const quarter = Math.floor(current.getMonth() / 3) + 1;
                    timeline.push({
                        date: new Date(current),
                        dateStr: current.toISOString().split('T')[0],
                        displayText: `Q${quarter} ${current.getFullYear()}`,
                        subText: current.getFullYear().toString(),
                        unit: 'quarter'
                    });
                    current.setMonth(current.getMonth() + 3);
                }
                return timeline;
            },

            generateSemiAnnualTimeline: (startDate, endDate) => {
                const timeline = [];
                const current = new Date(startDate.getFullYear(), startDate.getMonth() < 6 ? 0 : 6, 1);
                
                while (current <= endDate) {
                    const half = current.getMonth() < 6 ? 'H1' : 'H2';
                    timeline.push({
                        date: new Date(current),
                        dateStr: current.toISOString().split('T')[0],
                        displayText: `${half} ${current.getFullYear()}`,
                        subText: current.getFullYear().toString(),
                        unit: 'semiannual'
                    });
                    current.setMonth(current.getMonth() + 6);
                }
                return timeline;
            },

            generateAnnualTimeline: (startDate, endDate) => {
                const timeline = [];
                const current = new Date(startDate.getFullYear(), 0, 1);
                
                while (current <= endDate) {
                    timeline.push({
                        date: new Date(current),
                        dateStr: current.toISOString().split('T')[0],
                        displayText: current.getFullYear().toString(),
                        subText: '',
                        unit: 'annual'
                    });
                    current.setFullYear(current.getFullYear() + 1);
                }
                return timeline;
            },

            getWeekNumber: (date) => {
                const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const dayNum = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            },

            generateTimeline_old: (startDate, endDate) => {
                const timeline = [];
                const current = new Date(startDate);
                
                while (current <= endDate) {
                    timeline.push({
                        date: new Date(current),
                        dateStr: current.toISOString().split('T')[0],
                        dayOfWeek: current.getDay(),
                        isWeekend: current.getDay() === 0 || current.getDay() === 6
                    });
                    current.setDate(current.getDate() + 1);
                }
                
                return timeline;
            },

            generateGanttHTML: (tasks, users, timeline, minDate, maxDate, timeScale) => {
                const totalPeriods = timeline.length;
                const periodWidth = Render.getPeriodWidth(timeScale);
                const totalWidth = totalPeriods * periodWidth;
                
                let html = `
                    <div class="gantt-wrapper" style="min-width: ${totalWidth + 200}px;">
                        <!-- Header -->
                        <div class="flex border-b-2 border-slate-300 bg-slate-50 sticky top-0 z-10">
                            <div class="w-48 p-3 font-bold text-slate-700 border-r border-slate-300">Task / PR No.</div>
                            <div class="flex-1 relative">
                                <div class="flex">
                                    ${timeline.map(period => `
                                        <div class="border-r border-slate-200 text-center text-xs py-2 ${period.isWeekend ? 'bg-slate-100' : 'bg-white'}" 
                                             style="min-width: ${periodWidth}px; width: ${periodWidth}px;">
                                            <div class="font-medium">${period.displayText}</div>
                                            ${period.subText ? `<div class="text-slate-500">${period.subText}</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Task Rows -->
                        ${tasks.map((task, index) => {
                            const ownerName = users.find(u => u.id === task.owner_id)?.name || 'Unknown';
                            const milestones = Render.getTaskMilestones(task);
                            
                            return `
                                <div class="flex border-b border-slate-100 hover:bg-slate-50 ${index % 2 === 0 ? 'bg-white' : 'bg-slate-25'}">
                                    <div class="w-48 p-3 border-r border-slate-200">
                                        <div class="font-medium text-sm text-blue-600">${task.pr_no}</div>
                                        <div class="text-xs text-slate-500">${ownerName}</div>
                                        <div class="text-xs mt-1">
                                            <span class="px-2 py-1 rounded text-xs ${task.type === 'new' ? 'bg-purple-100 text-purple-600' : 'bg-teal-100 text-teal-600'}">${task.type.toUpperCase()}</span>
                                        </div>
                                    </div>
                                    <div class="flex-1 relative" style="height: 60px;">
                                        ${Render.generateTaskBars(task, milestones, timeline, periodWidth, minDate, timeScale)}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                return html;
            },

            getPeriodWidth: (timeScale) => {
                const widths = {
                    days: 30,
                    weeks: 50,
                    months: 80,
                    quarters: 120,
                    semiannual: 150,
                    annual: 200
                };
                return widths[timeScale] || 30;
            },

            getTaskMilestones: (task) => {
                const milestones = [];
                
                if (task.type === 'new') {
                    const sequence = ['vendor_list', 'rfq_float', 'target_prices', 'comparison', 'po_issuance'];
                    const labels = ['Vendor List', 'RFQ Float', 'Target Prices', 'Comparison', 'PO Issue'];
                    
                    sequence.forEach((key, index) => {
                        const planned = task.milestones[key];
                        const actual = task.milestones[`${key}_actual`];
                        
                        milestones.push({
                            key,
                            label: labels[index],
                            planned: planned ? new Date(planned) : null,
                            actual: actual ? new Date(actual) : null,
                            order: index,
                            isLast: index === sequence.length - 1
                        });
                    });
                } else {
                    const sequence = ['prices_confirm', 'comparison', 'po_issuance'];
                    const labels = ['Price Confirm', 'Comparison', 'PO Issue'];
                    
                    sequence.forEach((key, index) => {
                        const planned = task.milestones[key];
                        const actual = task.milestones[`${key}_actual`];
                        
                        milestones.push({
                            key,
                            label: labels[index],
                            planned: planned ? new Date(planned) : null,
                            actual: actual ? new Date(actual) : null,
                            order: index,
                            isLast: index === sequence.length - 1
                        });
                    });
                }
                
                return milestones.filter(m => m.planned || m.actual);
            },

            generateTaskBars: (task, milestones, timeline, periodWidth, minDate, timeScale) => {
                if (milestones.length === 0) return '<div class="text-xs text-slate-400 p-2">No milestones</div>';
                
                let html = '';
                
                // Generate milestone diamonds and connections
                milestones.forEach((milestone, index) => {
                    const plannedPos = milestone.planned ? Render.getDatePosition(milestone.planned, timeline, periodWidth, timeScale) : null;
                    const actualPos = milestone.actual ? Render.getDatePosition(milestone.actual, timeline, periodWidth, timeScale) : null;
                    
                    // Planned milestone (diamond)
                    if (plannedPos !== null) {
                        html += `
                            <div class="absolute" style="left: ${plannedPos}px; top: 15px;">
                                <div class="w-3 h-3 bg-blue-500 transform rotate-45 border border-blue-600" title="Planned: ${milestone.label} - ${milestone.planned.toLocaleDateString()}"></div>
                            </div>
                        `;
                    }
                    
                    // Actual milestone (circle)
                    if (actualPos !== null) {
                        const isEarly = milestone.planned && milestone.actual && milestone.actual <= milestone.planned;
                        const color = isEarly ? 'green' : (milestone.planned ? 'red' : 'blue');
                        
                        html += `
                            <div class="absolute" style="left: ${actualPos}px; top: 35px;">
                                <div class="w-3 h-3 bg-${color}-500 rounded-full border border-${color}-600" title="Actual: ${milestone.label} - ${milestone.actual.toLocaleDateString()}"></div>
                            </div>
                        `;
                    }
                    
                    // Connection line to next milestone (planned)
                    if (!milestone.isLast && index < milestones.length - 1) {
                        const nextMilestone = milestones[index + 1];
                        if (plannedPos !== null && nextMilestone.planned) {
                            const nextPos = Render.getDatePosition(nextMilestone.planned, timeline, periodWidth, timeScale);
                            if (nextPos !== null && nextPos > plannedPos) {
                                html += `
                                    <div class="absolute border-t border-blue-300" style="left: ${plannedPos + 6}px; top: 21px; width: ${nextPos - plannedPos - 6}px;"></div>
                                `;
                            }
                        }
                    }
                });
                
                // Legend
                html += `
                    <div class="absolute bottom-1 left-2 text-xs text-slate-500">
                        <span class="mr-3">â—† Planned</span>
                        <span>â— Actual</span>
                    </div>
                `;
                
                return html;
            },

            getDatePosition: (date, timeline, periodWidth, timeScale) => {
                if (timeScale === 'days') {
                    const dateStr = date.toISOString().split('T')[0];
                    const index = timeline.findIndex(period => period.dateStr === dateStr);
                    return index >= 0 ? index * periodWidth + periodWidth / 2 - 6 : null;
                } else {
                    // For other time scales, find the period that contains this date
                    let foundIndex = -1;
                    
                    for (let i = 0; i < timeline.length; i++) {
                        const period = timeline[i];
                        const periodStart = period.date;
                        let periodEnd;
                        
                        switch (timeScale) {
                            case 'weeks':
                                periodEnd = period.endDate || new Date(period.date.getTime() + 6 * 24 * 60 * 60 * 1000);
                                break;
                            case 'months':
                                periodEnd = new Date(period.date.getFullYear(), period.date.getMonth() + 1, 0);
                                break;
                            case 'quarters':
                                periodEnd = new Date(period.date.getFullYear(), period.date.getMonth() + 3, 0);
                                break;
                            case 'semiannual':
                                periodEnd = new Date(period.date.getFullYear(), period.date.getMonth() + 6, 0);
                                break;
                            case 'annual':
                                periodEnd = new Date(period.date.getFullYear() + 1, 0, 0);
                                break;
                            default:
                                periodEnd = new Date(period.date.getTime() + 24 * 60 * 60 * 1000);
                        }
                        
                        if (date >= periodStart && date <= periodEnd) {
                            foundIndex = i;
                            break;
                        }
                    }
                    
                    return foundIndex >= 0 ? foundIndex * periodWidth + periodWidth / 2 - 6 : null;
                }
            },

            adminPanel: () => {
                const users = db.getUsers();
                const html = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">User Management</h2>
                        <button onclick="Modal.openUserModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow flex items-center gap-2">
                            <i class="fas fa-user-plus"></i> Add User
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-slate-600 font-bold border-b">
                                <tr>
                                    <th class="p-4">Name</th>
                                    <th class="p-4">Username</th>
                                    <th class="p-4">Role</th>
                                    <th class="p-4">Reports To</th>
                                    <th class="p-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${users.map(u => `
                                <tr class="hover:bg-slate-50 transition">
                                    <td class="p-4 font-medium">${u.name}</td>
                                    <td class="p-4 text-slate-600">${u.username}</td>
                                    <td class="p-4"><span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-700">${u.role}</span></td>
                                    <td class="p-4 text-slate-600">${u.reports_to && u.reports_to.length > 0 ? u.reports_to.map(r => r.name).join(', ') : 'None'}</td>
                                    <td class="p-4">
                                        <button onclick="Modal.openUserModal('${u.id}')" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button>
                                        <button onclick="handleDeleteUser('${u.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('app').innerHTML = Render.layout(html);
            }
        };

        /**
         * ------------------------------------------------------------------
         * MODAL & FORM LOGIC
         * ------------------------------------------------------------------
         */
        const Modal = {
            openTaskModal: (taskId = null) => {
                const projects = db.getProjects();
                const tasks = db.getTasks();
                const users = db.getUsers();
                const task = taskId ? tasks.find(t => t.id === taskId) : null;
                const isNew = !task;
                
                // Logic for "Assign To" dropdown
                let assignOptions = [];
                let showAssign = false;
                
                if (currentUser.role !== 'engineer') {
                    showAssign = true;
                    // Get subordinates (Engineer list)
                    if (currentUser.role === "manager") {
                        // Managers can only assign to their direct engineer reports
                        assignOptions = users.filter(u => 
                            u.role === "engineer" && 
                            u.reports_to && 
                            u.reports_to.some(report => report.id === currentUser.id)
                        );
                    } else if (currentUser.role === "admin") {
                        // Admins can assign to anyone
                        assignOptions = users;
                    } else {
                        // Directors and above get all subordinates
                        assignOptions = AuthService.getSubordinates(currentUser.id);
                    }
                    // Add self to list if user wants to assign to self
                    if (!assignOptions.some(u => u.id === currentUser.id)) {
                        assignOptions.unshift(currentUser);
                    }
                }

                // Default Assigned User
                let assignedUserId = currentUser.id;
                if (task) assignedUserId = task.owner_id;

                const modalHtml = `
                    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                                <h3 class="text-xl font-bold text-slate-800">${isNew ? 'New Task' : 'Edit Task'}</h3>
                                <button onclick="document.getElementById('modal-overlay').remove()" class="text-slate-500 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
                            </div>
                            <div class="p-6">
                                <form id="taskForm" onsubmit="handleTaskSave(event, ${taskId})">
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">PR No.</label>
                                            <input type="text" name="pr_no" class="w-full border rounded p-2" required value="${task ? task.pr_no : ''}">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Project</label>
                                            <select name="project" class="w-full border rounded p-2">
                                                ${projects.map(p => `<option ${task && task.project === p ? 'selected' : ''}>${p}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Task Weight - Required Field -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2 text-red-600">Task Weight (Required) *</label>
                                        <div class="relative">
                                            <input type="range" min="1" max="10" value="${task ? task.task_weight || 5 : 5}" 
                                                   name="task_weight" required onchange="updateWeightDisplay(this.value)" 
                                                   class="w-full accent-blue-600">
                                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                <span>Simple (1)</span>
                                                <span id="weightValue" class="font-bold text-blue-600">Standard (5)</span>
                                                <span>Critical (10)</span>
                                            </div>
                                        </div>
                                        <div class="mt-2 text-xs text-gray-600 bg-blue-50 p-2 rounded">
                                            <strong>Weight Guidelines:</strong><br>
                                            1-3: Routine purchases, standard suppliers<br>
                                            4-6: Important procurement, some complexity<br>
                                            7-8: Critical equipment, tight deadlines<br>
                                            9-10: Emergency procurement, high business impact
                                        </div>
                                        ${!isNew ? `<div class="text-xs text-gray-500 mt-1">Current weight can only be modified by manager+</div>` : ''}
                                    </div>
                                    
                                    ${showAssign ? `
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-1">Assign To</label>
                                        <select name="assign_to" class="w-full border rounded p-2">
                                            ${assignOptions.map(u => `<option value="${u.id}" ${assignedUserId === u.id ? 'selected' : ''}>${u.name} (${u.role})</option>`).join('')}
                                        </select>
                                    </div>` : ''}
                                    
                                    <div class="grid grid-cols-3 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Type</label>
                                            <select name="type" id="typeSelect" onchange="toggleFormFields()" class="w-full border rounded p-2">
                                                <option value="new" ${task && task.type === 'new' ? 'selected' : ''}>New Request</option>
                                                <option value="repeat" ${task && task.type === 'repeat' ? 'selected' : ''}>Repeat Request</option>
                                            </select>
                                        </div>
                                        <div class="flex items-center">
                                            <label class="flex items-center">
                                                <input type="checkbox" name="is_permanent" class="mr-2" ${task && task.is_permanent ? 'checked' : ''} onchange="toggleMaterialSubmittalSection()">
                                                <span class="text-sm font-medium">Permanent</span>
                                            </label>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Assignment Date</label>
                                            <input type="date" name="assignment_date" class="w-full border rounded p-2" required value="${task ? task.assignment_date : new Date().toISOString().split('T')[0]}">
                                        </div>
                                    </div>

                                    <!-- Milestone Fields for New Request -->
                                    <div id="new-request-fields" class="${task && task.type === 'repeat' ? 'hidden' : ''}">
                                        <h4 class="font-medium mb-2 text-slate-700">New Request Milestones</h4>
                                        <div class="grid grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Vendor List</label>
                                                <input type="date" name="vendor_list" class="w-full border rounded p-2" value="${task?.milestones?.vendor_list || ''}">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-1">RFQ Float</label>
                                                <input type="date" name="rfq_float" class="w-full border rounded p-2" value="${task?.milestones?.rfq_float || ''}">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Target Prices</label>
                                                <input type="date" name="target_prices" class="w-full border rounded p-2" value="${task?.milestones?.target_prices || ''}">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Comparison</label>
                                                <input type="date" name="comparison" class="w-full border rounded p-2" value="${task?.milestones?.comparison || ''}">
                                            </div>
                                        </div>
                                        
                                        <!-- Material Submittal Section (for permanent PRs only) -->
                                        <div id="material-submittal-section" class="${!task?.is_permanent ? 'hidden' : ''}">
                                            <h5 class="font-medium mb-3 text-slate-700 text-purple-700">Material Submittal (Permanent PR)</h5>
                                            <div class="bg-purple-50 rounded-lg p-4 border border-purple-200 mb-4">
                                                <div class="mb-3">
                                                    <label class="block text-sm font-medium mb-2">Material Submittal Required?</label>
                                                    <div class="flex gap-4">
                                                        <label class="flex items-center">
                                                            <input type="radio" name="material_submittal_required" value="Yes" class="mr-2" ${task?.milestones?.material_submittal_required === 'Yes' ? 'checked' : ''} onchange="toggleMaterialSubmittalFields()">
                                                            <span class="text-sm">Yes</span>
                                                        </label>
                                                        <label class="flex items-center">
                                                            <input type="radio" name="material_submittal_required" value="No" class="mr-2" ${task?.milestones?.material_submittal_required === 'No' ? 'checked' : ''} onchange="toggleMaterialSubmittalFields()">
                                                            <span class="text-sm">No</span>
                                                        </label>
                                                    </div>
                                                </div>
                                                
                                                <div id="material-submittal-fields" class="${task?.milestones?.material_submittal_required !== 'Yes' ? 'hidden' : ''}">
                                                    <div class="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <label class="block text-sm font-medium mb-1">Material Submittal</label>
                                                            <input type="date" name="material_submittal_submitted" class="w-full border rounded p-2" value="${task?.milestones?.material_submittal_submitted || ''}">
                                                        </div>
                                                        <div>
                                                            <label class="block text-sm font-medium mb-1">Submittal Approval</label>
                                                            <input type="date" name="material_submittal_approved" class="w-full border rounded p-2" value="${task?.milestones?.material_submittal_approved || ''}">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium mb-1">PO Issuance</label>
                                                <input type="date" name="po_issuance" class="w-full border rounded p-2" value="${task?.milestones?.po_issuance || ''}">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Milestone Fields for Repeat Request -->
                                    <div id="repeat-request-fields" class="${!task || task.type === 'new' ? 'hidden' : ''}">
                                        <h4 class="font-medium mb-2 text-slate-700">Repeat Request Milestones</h4>
                                        <div class="grid grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Price Confirmation</label>
                                                <input type="date" name="prices_confirm" class="w-full border rounded p-2" value="${task?.milestones?.prices_confirm || ''}">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Comparison</label>
                                                <input type="date" name="comparison_rep" class="w-full border rounded p-2" value="${task?.milestones?.comparison || ''}">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-1">PO Issuance</label>
                                                <input type="date" name="po_issuance_rep" class="w-full border rounded p-2" value="${task?.milestones?.po_issuance || ''}">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-end space-x-3">
                                        <button type="button" onclick="document.getElementById('modal-overlay').remove()" class="px-4 py-2 border rounded text-slate-600 hover:bg-slate-100">Cancel</button>
                                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Task</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            },
            
            editTask: (id) => {
                Modal.openTaskModal(id);
            },

            openUserModal: (userId) => {
                const users = db.getUsers();
                const user = userId ? users.find(u => u.id === userId) : null;
                const modalHtml = `
                    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
                        <div class="bg-white rounded-lg shadow-xl w-96">
                            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                                <h3 class="text-xl font-bold text-slate-800">${user ? 'Edit User' : 'New User'}</h3>
                                <button onclick="document.getElementById('modal-overlay').remove()" class="text-slate-500 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
                            </div>
                            <div class="p-6">
                                <form onsubmit="handleUserSave(event, ${user ? `'${user.id}'` : 'null'})">
                                    ${!user ? '<div class="mb-4"><label class="block text-sm font-medium mb-1">Username</label><input type="text" name="username" class="w-full border rounded p-2" required></div>' : ''}
                                    ${!user ? '<div class="mb-4"><label class="block text-sm font-medium mb-1">Password</label><input type="password" name="password" class="w-full border rounded p-2" required></div>' : ''}
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-1">Name</label>
                                        <input type="text" name="name" class="w-full border rounded p-2" required value="${user ? user.name : ''}">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-1">Role</label>
                                        <select name="role" class="w-full border rounded p-2">
                                            <option value="engineer" ${user && user.role === 'engineer' ? 'selected' : ''}>Engineer</option>
                                            <option value="manager" ${user && user.role === 'manager' ? 'selected' : ''}>Manager</option>
                                            <option value="director" ${user && user.role === 'director' ? 'selected' : ''}>Director</option>
                                            <option value="vp" ${user && user.role === 'vp' ? 'selected' : ''}>VP</option>
                                            <option value="admin" ${user && user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-1">Reports To (Multi-select)</label>
                                        <select name="reports_to" multiple class="w-full border rounded p-2 h-24">
                                            ${users.filter(u => u.id !== (user ? user.id : '')).map(u => `
                                                <option value="${u.id}" ${user && user.reports_to && user.reports_to.some(r => r.id === u.id) ? 'selected' : ''}>${u.name} (${u.role})</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Save User</button>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            },

            viewTask: (taskId) => {
                const task = db.getTasks().find(t => t.id === taskId);
                const users = db.getUsers();
                if (!task) return;
                
                const owner = users.find(u => u.id === task.owner_id);
                const ownerName = owner ? owner.name : 'Unknown';
                
                // Determine status styling
                let statusStyling = {
                    headerBg: 'bg-blue-600',
                    headerText: 'text-blue-100',
                    statusIcon: 'fas fa-info-circle',
                    statusColor: 'text-blue-600',
                    canModify: true
                };
                
                if (task.status === 'Closed') {
                    statusStyling = {
                        headerBg: 'bg-green-600',
                        headerText: 'text-green-100',
                        statusIcon: 'fas fa-check-circle',
                        statusColor: 'text-green-600',
                        canModify: false
                    };
                } else if (task.status === 'Cancelled') {
                    statusStyling = {
                        headerBg: 'bg-red-600',
                        headerText: 'text-red-100',
                        statusIcon: 'fas fa-times-circle',
                        statusColor: 'text-red-600',
                        canModify: false
                    };
                } else if (task.status === 'On Hold') {
                    statusStyling = {
                        headerBg: 'bg-yellow-600',
                        headerText: 'text-yellow-100',
                        statusIcon: 'fas fa-pause-circle',
                        statusColor: 'text-yellow-600',
                        canModify: false
                    };
                }

                // Generate milestone details
                let milestoneHtml = '';
                if (task.type === 'new') {
                    const milestones = [
                        { key: 'vendor_list', label: 'Vendor List' },
                        { key: 'rfq_float', label: 'RFQ Float' },
                        { key: 'target_prices', label: 'Target Prices' },
                        { key: 'comparison', label: 'Comparison' },
                        { key: 'po_issuance', label: 'PO Issuance' }
                    ];
                    
                    milestoneHtml = milestones.map(m => {
                        const planned = task.milestones[m.key];
                        const actual = task.milestones[`${m.key}_actual`];
                        const status = actual ? (planned && new Date(actual) > new Date(planned) ? 'ðŸ”´ Late' : 'ðŸŸ¢ Complete') : (planned ? 'ðŸŸ¡ Planned' : 'âšª Not Set');
                        
                        return `
                            <div class="grid grid-cols-3 gap-4 py-2 border-b border-gray-100">
                                <div class="font-medium">${m.label}</div>
                                <div class="text-sm">${planned ? new Date(planned).toLocaleDateString() : 'Not set'}</div>
                                <div class="text-sm">${actual ? new Date(actual).toLocaleDateString() + ' ' + status : status}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    const milestones = [
                        { key: 'prices_confirm', label: 'Price Confirmation' },
                        { key: 'comparison', label: 'Comparison' },
                        { key: 'po_issuance', label: 'PO Issuance' }
                    ];
                    
                    milestoneHtml = milestones.map(m => {
                        const planned = task.milestones[m.key];
                        const actual = task.milestones[`${m.key}_actual`];
                        const status = actual ? (planned && new Date(actual) > new Date(planned) ? 'ðŸ”´ Late' : 'ðŸŸ¢ Complete') : (planned ? 'ðŸŸ¡ Planned' : 'âšª Not Set');
                        
                        return `
                            <div class="grid grid-cols-3 gap-4 py-2 border-b border-gray-100">
                                <div class="font-medium">${m.label}</div>
                                <div class="text-sm">${planned ? new Date(planned).toLocaleDateString() : 'Not set'}</div>
                                <div class="text-sm">${actual ? new Date(actual).toLocaleDateString() + ' ' + status : status}</div>
                            </div>
                        `;
                    }).join('');
                }

                const modalHtml = `
                    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                            <div class="p-6 border-b ${statusStyling.headerBg} text-white">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h3 class="text-2xl font-bold">PR Task Details</h3>
                                        <p class="${statusStyling.headerText} text-sm">${task.pr_no} - ${task.project}</p>
                                    </div>
                                    <button onclick="document.getElementById('modal-overlay').remove()" class="${statusStyling.headerText} hover:text-white text-xl">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="p-6">
                                <!-- Task Overview -->
                                <div class="grid grid-cols-2 gap-6 mb-6">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">PR Number</label>
                                            <div class="text-lg font-semibold">${task.pr_no}</div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Project</label>
                                            <div class="text-lg">${task.project}</div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Owner</label>
                                            <div class="text-lg">${ownerName}</div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Type</label>
                                            <div class="text-lg"><span class="px-3 py-1 rounded text-sm ${task.type === 'new' ? 'bg-purple-100 text-purple-700' : 'bg-teal-100 text-teal-700'}">${task.type.toUpperCase()}</span></div>
                                        </div>
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Status</label>
                                            <div class="text-lg flex items-center">
                                                <i class="${statusStyling.statusIcon} ${statusStyling.statusColor} mr-2"></i>
                                                ${task.status}
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Assignment Date</label>
                                            <div class="text-lg">${new Date(task.assignment_date).toLocaleDateString()}</div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Current Stage</label>
                                            <div class="text-lg">${task.current_stage ? task.current_stage.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Not set'}</div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Action By</label>
                                            <div class="text-lg">${task.action_by ? task.action_by.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Not specified'}</div>
                                        </div>
                                        ${task.status === 'Closed' && task.completion_date ? `
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Completed On</label>
                                            <div class="text-lg text-green-600">${new Date(task.completion_date).toLocaleDateString()}</div>
                                        </div>` : ''}
                                        ${task.status === 'Cancelled' && task.cancellation_date ? `
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Cancelled On</label>
                                            <div class="text-lg text-red-600">${new Date(task.cancellation_date).toLocaleDateString()}</div>
                                        </div>` : ''}
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Permanent</label>
                                            <div class="text-lg">${task.is_permanent ? 'Yes' : 'No'}</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Milestones Section -->
                                <div class="border-t pt-6">
                                    <h4 class="text-lg font-bold mb-4">Milestones Progress</h4>
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <div class="grid grid-cols-3 gap-4 py-2 border-b-2 border-gray-200 font-semibold text-gray-700">
                                            <div>Milestone</div>
                                            <div>Planned Date</div>
                                            <div>Actual Date & Status</div>
                                        </div>
                                        ${milestoneHtml}
                                    </div>
                                </div>

                                <!-- Engineer Remarks Timeline Section -->
                                ${task.remarks && Array.isArray(task.remarks) && task.remarks.length > 0 ? `
                                <div class="border-t pt-6">
                                    <h4 class="text-lg font-bold mb-4">Engineer Notes Timeline (${task.remarks.length} entries)</h4>
                                    <div class="bg-blue-50 rounded-lg p-4 max-h-60 overflow-y-auto">
                                        <div class="space-y-3">
                                            ${task.remarks.slice().reverse().map((entry, index) => `
                                                <div class="bg-white rounded-lg p-3 border-l-4 border-blue-400">
                                                    <div class="flex justify-between items-start mb-2">
                                                        <span class="text-xs font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded">Note #${task.remarks.length - index}</span>
                                                        <span class="text-xs text-gray-500">${new Date(entry.timestamp).toLocaleString()}</span>
                                                    </div>
                                                    <p class="text-gray-800 text-sm whitespace-pre-wrap">${entry.text}</p>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>` : ''}

                                <!-- Actions -->
                                <div class="border-t pt-6 flex justify-end space-x-3">
                                    <button onclick="document.getElementById('modal-overlay').remove()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                        Close
                                    </button>
                                    ${task.status === 'Closed' && (currentUser.role === 'manager' || currentUser.role === 'director' || currentUser.role === 'vp' || currentUser.role === 'admin') && AuthService.isManagerOf(currentUser.id, task.owner_id) ? `
                                    <button onclick="document.getElementById('modal-overlay').remove(); handleReopenTask(${taskId})" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition">
                                        <i class="fas fa-undo mr-2"></i>Re-open Task
                                    </button>` : ''}
                                    ${statusStyling.canModify && (currentUser.role === 'manager' || currentUser.role === 'director' || currentUser.role === 'vp' || currentUser.role === 'admin') && AuthService.isManagerOf(currentUser.id, task.owner_id) ? `
                                    <button onclick="document.getElementById('modal-overlay').remove(); Modal.openReassignModal(${taskId})" class="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition">
                                        <i class="fas fa-user-edit mr-2"></i>Reassign
                                    </button>` : ''}
                                    ${statusStyling.canModify && (currentUser.role === 'admin' || (currentUser.role !== 'engineer' && AuthService.isManagerOf(currentUser.id, task.owner_id))) ? `
                                    <button onclick="document.getElementById('modal-overlay').remove(); Modal.editTask(${taskId})" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                                        Edit Task
                                    </button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML("beforeend", modalHtml);
            },

            openWeightOverrideModal: (taskId) => {
                const tasks = db.getTasks();
                const users = db.getUsers();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                const weightSetBy = users.find(u => u.id === task.weight_set_by);
                const weightModifiedBy = task.weight_modified_by ? users.find(u => u.id === task.weight_modified_by) : null;
                
                const modalHtml = `
                    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                            <div class="p-6 border-b flex justify-between items-center bg-orange-600 text-white">
                                <h3 class="text-xl font-bold">Modify Task Weight</h3>
                                <button onclick="document.getElementById('modal-overlay').remove()" class="text-orange-100 hover:text-white text-xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="p-6">
                                <form onsubmit="handleWeightOverride(event, ${taskId})">
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2 text-gray-700">Task Details</label>
                                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                            <div class="font-medium text-blue-600">${task.pr_no}</div>
                                            <div class="text-sm text-gray-600">${task.project}</div>
                                            <div class="text-sm text-gray-500 mt-1">Owner: ${users.find(u => u.id === task.owner_id)?.name || 'Unknown'}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2 text-gray-700">Current Weight</label>
                                        <div class="text-2xl font-bold text-blue-600 mb-2">${task.task_weight || 5}/10</div>
                                        <div class="text-xs text-gray-500">
                                            Originally set by: ${weightSetBy ? weightSetBy.name : 'Unknown'}<br>
                                            ${weightModifiedBy ? `Last modified by: ${weightModifiedBy.name} on ${new Date(task.weight_modified_at).toLocaleDateString()}` : 'Never modified'}
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2 text-gray-700">New Weight</label>
                                        <input type="range" min="1" max="10" value="${task.task_weight || 5}" 
                                               name="new_weight" class="w-full accent-orange-600"
                                               onchange="updateWeightDisplayModal(this.value)">
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>Simple (1)</span>
                                            <span id="weightValueModal" class="font-bold text-orange-600">Current</span>
                                            <span>Critical (10)</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label class="block text-sm font-medium mb-2 text-gray-700">Reason for Change (Required)</label>
                                        <textarea name="reason" rows="3" 
                                                  placeholder="Why is this weight being modified? (e.g., Increased complexity, changed requirements, etc.)" 
                                                  class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-orange-500 outline-none" 
                                                  required></textarea>
                                    </div>
                                    
                                    <div class="flex justify-end space-x-3">
                                        <button type="button" onclick="document.getElementById('modal-overlay').remove()" 
                                                class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-100 transition">
                                            Cancel
                                        </button>
                                        <button type="submit" 
                                                class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition">
                                            Update Weight
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Initialize display
                updateWeightDisplayModal(task.task_weight || 5);
            },

            openWeightOverrideModal: (taskId) => {
                const tasks = db.getTasks();
                const users = db.getUsers();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                const weightSetBy = users.find(u => u.id === task.weight_set_by);
                const weightModifiedBy = task.weight_modified_by ? users.find(u => u.id === task.weight_modified_by) : null;

                const modalHtml = `
                    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                            <div class="p-6 border-b flex justify-between items-center bg-orange-600 text-white">
                                <h3 class="text-xl font-bold">Modify Task Weight</h3>
                                <button onclick="document.getElementById('modal-overlay').remove()" class="text-orange-100 hover:text-white text-xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="p-6">
                                <form onsubmit="handleWeightOverride(event, ${taskId})">
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2 text-gray-700">Task Details</label>
                                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                            <div class="font-medium text-blue-600">${task.pr_no}</div>
                                            <div class="text-sm text-gray-600">${task.project}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2 text-gray-700">Current Weight</label>
                                        <div class="flex items-center space-x-3">
                                            <div class="text-2xl font-bold text-blue-600">${task.task_weight || 5}/10</div>
                                            <div class="text-sm text-gray-500">
                                                <div>Set by: ${weightSetBy ? weightSetBy.name : 'Unknown'}</div>
                                                ${weightModifiedBy ? `<div>Modified by: ${weightModifiedBy.name} on ${new Date(task.weight_modified_at).toLocaleDateString()}</div>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2 text-gray-700">New Weight</label>
                                        <input type="range" min="1" max="10" value="${task.task_weight || 5}" 
                                               name="new_weight" id="newWeightSlider" 
                                               onchange="updateNewWeightDisplay(this.value)" 
                                               class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>Routine (1)</span>
                                            <span id="newWeightValue" class="font-bold text-orange-600">Current (${task.task_weight || 5})</span>
                                            <span>Critical (10)</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label class="block text-sm font-medium mb-2 text-gray-700">Reason for Change (Required)</label>
                                        <textarea name="reason" placeholder="Explain why this weight is being modified..." 
                                                  class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-orange-500 outline-none" 
                                                  rows="3" required></textarea>
                                    </div>
                                    
                                    <div class="flex justify-end space-x-3">
                                        <button type="button" onclick="document.getElementById('modal-overlay').remove()" class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-100 transition">
                                            Cancel
                                        </button>
                                        <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition">
                                            Update Weight
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            },

            openReassignModal: (taskId) => {
                const tasks = db.getTasks();
                const users = db.getUsers();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                // Get list of users that can be assigned to
                let assignOptions = [];
                
                if (currentUser.role === "manager") {
                    // Managers can reassign to their direct engineer reports + themselves
                    assignOptions = users.filter(u => 
                        u.role === "engineer" && 
                        u.reports_to && 
                        u.reports_to.some(report => report.id === currentUser.id)
                    );
                    assignOptions.unshift(currentUser); // Add self
                } else if (currentUser.role === "admin") {
                    // Admins can reassign to anyone
                    assignOptions = users;
                } else {
                    // Directors and above get all subordinates + themselves
                    assignOptions = AuthService.getSubordinates(currentUser.id);
                    if (!assignOptions.some(u => u.id === currentUser.id)) {
                        assignOptions.unshift(currentUser);
                    }
                }

                const currentOwner = users.find(u => u.id === task.owner_id);
                
                const modalHtml = `
                    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                            <div class="p-6 border-b flex justify-between items-center bg-purple-600 text-white">
                                <h3 class="text-xl font-bold">Reassign Task</h3>
                                <button onclick="document.getElementById('modal-overlay').remove()" class="text-purple-100 hover:text-white text-xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="p-6">
                                <form onsubmit="handleReassignTask(event, ${taskId})">
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2 text-gray-700">Task Details</label>
                                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                            <div class="font-medium text-blue-600">${task.pr_no}</div>
                                            <div class="text-sm text-gray-600">${task.project}</div>
                                            <div class="text-sm text-gray-500 mt-1">Currently assigned to: <span class="font-medium">${currentOwner ? currentOwner.name : 'Unknown'}</span></div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label class="block text-sm font-medium mb-2 text-gray-700">Reassign To</label>
                                        <select name="new_owner" class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-purple-500 outline-none" required>
                                            <option value="">Select new assignee...</option>
                                            ${assignOptions.map(u => `
                                                <option value="${u.id}" ${u.id === task.owner_id ? 'selected' : ''}>
                                                    ${u.name} (${u.role})
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label class="block text-sm font-medium mb-2 text-gray-700">Reason for Reassignment (Optional)</label>
                                        <textarea name="reassign_reason" rows="3" class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Enter reason for reassignment..."></textarea>
                                    </div>
                                    
                                    <div class="flex justify-end space-x-3">
                                        <button type="button" onclick="document.getElementById('modal-overlay').remove()" class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-100 transition">
                                            Cancel
                                        </button>
                                        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                                            Reassign Task
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            },

            openRemarksModal: (taskId) => {
                const tasks = db.getTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                const remarks = Array.isArray(task.remarks) ? task.remarks : [];

                const modalHtml = `
                    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                            <div class="p-6 border-b flex justify-between items-center bg-green-600 text-white">
                                <div>
                                    <h3 class="text-xl font-bold">Task Notes Timeline</h3>
                                    <p class="text-green-100 text-sm">${task.pr_no} - ${task.project}</p>
                                </div>
                                <button onclick="document.getElementById('modal-overlay').remove()" class="text-green-100 hover:text-white text-xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="p-6">
                                <!-- Existing Notes Timeline -->
                                ${remarks.length > 0 ? `
                                <div class="mb-6">
                                    <h4 class="text-lg font-semibold mb-4 text-gray-700">Previous Notes</h4>
                                    <div class="space-y-3 max-h-60 overflow-y-auto">
                                        ${remarks.map((entry, index) => `
                                            <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-blue-400">
                                                <div class="flex justify-between items-start mb-2">
                                                    <span class="text-xs font-medium text-blue-600">#${index + 1}</span>
                                                    <span class="text-xs text-gray-500">${new Date(entry.timestamp).toLocaleString()}</span>
                                                </div>
                                                <p class="text-gray-800 text-sm whitespace-pre-wrap">${entry.text}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : `
                                <div class="mb-6 text-center py-8">
                                    <i class="fas fa-comment-slash text-4xl text-gray-300 mb-3"></i>
                                    <p class="text-gray-500">No notes yet. Add your first note below.</p>
                                </div>
                                `}

                                <!-- Add New Note -->
                                <div class="border-t pt-6">
                                    <form onsubmit="handleAddNewRemark(event, ${taskId})">
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium mb-2 text-gray-700">Add New Note</label>
                                            <textarea name="new_remark" placeholder="Enter your new note, update, or observation..." 
                                                      class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none" 
                                                      rows="4" required></textarea>
                                        </div>
                                        
                                        <div class="flex justify-end space-x-3">
                                            <button type="button" onclick="document.getElementById('modal-overlay').remove()" class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-100 transition">
                                                Close
                                            </button>
                                            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                                <i class="fas fa-plus mr-2"></i>Add Note
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            },

            viewRemarksModal: (taskId) => {
                const tasks = db.getTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                const remarks = Array.isArray(task.remarks) ? task.remarks : [];

                const modalHtml = `
                    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                            <div class="p-6 border-b flex justify-between items-center bg-blue-600 text-white">
                                <div>
                                    <h3 class="text-xl font-bold">Engineer Notes Timeline</h3>
                                    <p class="text-blue-100 text-sm">${task.pr_no} - ${task.project}</p>
                                </div>
                                <button onclick="document.getElementById('modal-overlay').remove()" class="text-blue-100 hover:text-white text-xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="p-6">
                                ${remarks.length > 0 ? `
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-lg font-semibold text-gray-700">Timeline (${remarks.length} notes)</h4>
                                        <span class="text-sm text-gray-500">Latest first</span>
                                    </div>
                                    <div class="space-y-4 max-h-96 overflow-y-auto">
                                        ${remarks.slice().reverse().map((entry, index) => `
                                            <div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
                                                <div class="flex justify-between items-start mb-3">
                                                    <span class="text-xs font-medium text-blue-700 bg-blue-100 px-2 py-1 rounded">Note #${remarks.length - index}</span>
                                                    <span class="text-xs text-gray-600 font-medium">${new Date(entry.timestamp).toLocaleString()}</span>
                                                </div>
                                                <p class="text-gray-800 whitespace-pre-wrap leading-relaxed">${entry.text}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : `
                                <div class="text-center py-12">
                                    <i class="fas fa-comment-slash text-6xl text-gray-300 mb-4"></i>
                                    <p class="text-gray-500 text-lg">No notes available</p>
                                    <p class="text-gray-400 text-sm">The engineer hasn't added any notes yet.</p>
                                </div>
                                `}
                                
                                <div class="flex justify-center mt-6">
                                    <button onclick="document.getElementById('modal-overlay').remove()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            },

            openEngineerTaskModal: (taskId) => {
                const task = db.getTasks().find(t => t.id === taskId);
                if (!task) return;

                const getMilestoneStatus = (plannedDate, actualDate) => {
                    if (!plannedDate) return { status: 'no-plan', class: 'bg-gray-100 text-gray-600', icon: 'fas fa-minus' };
                    if (!actualDate) return { status: 'pending', class: 'bg-yellow-100 text-yellow-700', icon: 'fas fa-clock' };
                    
                    const planned = new Date(plannedDate);
                    const actual = new Date(actualDate);
                    
                    if (actual <= planned) {
                        return { status: 'on-time', class: 'bg-green-100 text-green-700', icon: 'fas fa-check-circle' };
                    } else {
                        return { status: 'delayed', class: 'bg-red-100 text-red-700', icon: 'fas fa-exclamation-triangle' };
                    }
                };

                let milestoneFields = '';
                if (task.type === 'new') {
                    const baseMilestones = [
                        { key: 'vendor_list', label: 'Vendor List' },
                        { key: 'rfq_float', label: 'RFQ Float' },
                        { key: 'target_prices', label: 'Target Prices' },
                        { key: 'comparison', label: 'Comparison' }
                    ];

                    // Build base milestone fields
                    milestoneFields = baseMilestones.map(m => {
                        const planned = task.milestones[m.key];
                        const actual = task.milestones[`${m.key}_actual`];
                        const status = getMilestoneStatus(planned, actual);
                        
                        return `
                            <div class="grid grid-cols-2 gap-4 p-4 border rounded-lg ${status.class}">
                                <div>
                                    <label class="block text-sm font-medium mb-1">${m.label} (Planned) <i class="${status.icon} ml-1"></i></label>
                                    <input type="date" value="${planned || ''}" class="w-full border rounded p-2 bg-gray-50" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">${m.label} (Actual)</label>
                                    <input type="date" name="${m.key}_actual" value="${actual || ''}" class="w-full border rounded p-2">
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Add material submittal section for permanent PRs
                    if (task.is_permanent) {
                        milestoneFields += `
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <h6 class="font-semibold mb-3 text-purple-700">Material Submittal (Permanent PR)</h6>
                                
                                ${task.milestones.material_submittal_required === 'Yes' ? `
                                    <div class="grid grid-cols-2 gap-4 mb-3">
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-purple-700">Material Submittal (Planned)</label>
                                            <input type="date" value="${task.milestones.material_submittal_submitted || ''}" class="w-full border rounded p-2 bg-gray-50" readonly>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-purple-700">Material Submittal (Actual)</label>
                                            <input type="date" name="material_submittal_submitted_actual" value="${task.milestones.material_submittal_submitted_actual || ''}" class="w-full border rounded p-2">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-purple-700">Submittal Approval (Planned)</label>
                                            <input type="date" value="${task.milestones.material_submittal_approved || ''}" class="w-full border rounded p-2 bg-gray-50" readonly>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-purple-700">Submittal Approval (Actual)</label>
                                            <input type="date" name="material_submittal_approved_actual" value="${task.milestones.material_submittal_approved_actual || ''}" class="w-full border rounded p-2">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="text-center py-4">
                                        <p class="text-purple-600 text-sm">Material submittal not required for this PR</p>
                                    </div>
                                `}
                            </div>
                        `;
                    }

                    // Add PO issuance as final milestone
                    const poPlanned = task.milestones.po_issuance;
                    const poActual = task.milestones.po_issuance_actual;
                    const poStatus = getMilestoneStatus(poPlanned, poActual);
                    
                    milestoneFields += `
                        <div class="grid grid-cols-2 gap-4 p-4 border rounded-lg ${poStatus.class}">
                            <div>
                                <label class="block text-sm font-medium mb-1">PO Issuance (Planned) <i class="${poStatus.icon} ml-1"></i></label>
                                <input type="date" value="${poPlanned || ''}" class="w-full border rounded p-2 bg-gray-50" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">PO Issuance (Actual)</label>
                                <input type="date" name="po_issuance_actual" value="${poActual || ''}" class="w-full border rounded p-2">
                            </div>
                        </div>
                    `;

                } else {
                    // Repeat request milestones (no material submittal)
                    const milestones = [
                        { key: 'prices_confirm', label: 'Price Confirmation' },
                        { key: 'comparison', label: 'Comparison' },
                        { key: 'po_issuance', label: 'PO Issuance' }
                    ];

                    milestoneFields = milestones.map(m => {
                        const planned = task.milestones[m.key];
                        const actual = task.milestones[`${m.key}_actual`];
                        const status = getMilestoneStatus(planned, actual);
                        
                        return `
                            <div class="grid grid-cols-2 gap-4 p-4 border rounded-lg ${status.class}">
                                <div>
                                    <label class="block text-sm font-medium mb-1">${m.label} (Planned) <i class="${status.icon} ml-1"></i></label>
                                    <input type="date" value="${planned || ''}" class="w-full border rounded p-2 bg-gray-50" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">${m.label} (Actual)</label>
                                    <input type="date" name="${m.key}_actual" value="${actual || ''}" class="w-full border rounded p-2">
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                const allMilestonesComplete = task.type === 'new' ?
                    ['vendor_list', 'rfq_float', 'target_prices', 'comparison', 'po_issuance'].every(key => 
                        task.milestones[`${key}_actual`]) :
                    ['prices_confirm', 'comparison', 'po_issuance'].every(key => 
                        task.milestones[`${key}_actual`]);

                const modalHtml = `
                    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="p-6 border-b flex justify-between items-center bg-blue-600 text-white">
                                <div>
                                    <h3 class="text-2xl font-bold">Update Milestones</h3>
                                    <p class="text-blue-100 text-sm">${task.pr_no} - ${task.project}</p>
                                </div>
                                <button onclick="document.getElementById('modal-overlay').remove()" class="text-blue-100 hover:text-white text-xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="p-6">
                                <form onsubmit="handleMilestoneUpdate(event, ${taskId})">
                                    <div class="space-y-4 mb-6">
                                        ${milestoneFields}
                                    </div>
                                    
                                    <!-- Quick Remarks Section -->
                                    <div class="border-t pt-4">
                                        <h5 class="text-md font-semibold mb-3 text-gray-700">Add Task Note</h5>
                                        ${task.remarks && Array.isArray(task.remarks) && task.remarks.length > 0 ? `
                                        <div class="mb-3 bg-gray-50 rounded-lg p-3 max-h-32 overflow-y-auto">
                                            <div class="text-xs text-gray-600 mb-2">Recent notes (${task.remarks.length} total):</div>
                                            ${task.remarks.slice(-2).reverse().map((entry, index) => `
                                                <div class="text-xs bg-white rounded p-2 mb-1">
                                                    <div class="text-gray-500">${new Date(entry.timestamp).toLocaleString()}</div>
                                                    <div class="text-gray-800">${entry.text.length > 60 ? entry.text.substring(0, 60) + '...' : entry.text}</div>
                                                </div>
                                            `).join('')}
                                        </div>` : ''}
                                        <div class="mb-3">
                                            <textarea name="quick_remarks" rows="3" class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none text-sm" 
                                                      placeholder="Add a note about your progress, issues, or updates..."></textarea>
                                            <div class="text-xs text-gray-500 mt-1">
                                                Optional: This will be added as a new timestamped note
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-between items-center">
                                        <div class="text-sm text-gray-600">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Update actual completion dates for each milestone
                                        </div>
                                        <div class="space-x-3">
                                            <button type="button" onclick="document.getElementById('modal-overlay').remove()" class="px-4 py-2 border rounded text-slate-600 hover:bg-slate-100">Cancel</button>
                                            <button type="submit" name="action" value="update" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update Progress</button>
                                            ${allMilestonesComplete ? '<button type="submit" name="action" value="complete" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Mark Complete</button>' : ''}
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
        };

        /**
         * ------------------------------------------------------------------
         * EVENT HANDLERS
         * ------------------------------------------------------------------
         */
        window.handleCompleteTask = async (taskId) => {
            try {
                const tasks = db.getTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                // Check if all required actual dates are filled
                const missingDates = [];
                if (task.type === 'new') {
                    if (!task.milestones.vendor_list_actual) missingDates.push('Vendor List');
                    if (!task.milestones.rfq_float_actual) missingDates.push('RFQ Float');
                    if (!task.milestones.target_prices_actual) missingDates.push('Target Prices');
                    if (!task.milestones.comparison_actual) missingDates.push('Comparison');
                    
                    // Check material submittal milestones for permanent PRs
                    if (task.is_permanent && task.milestones.material_submittal_required === 'Yes') {
                        if (!task.milestones.material_submittal_submitted_actual) missingDates.push('Material Submittal');
                        if (!task.milestones.material_submittal_approved_actual) missingDates.push('Submittal Approval');
                    }
                    
                    if (!task.milestones.po_issuance_actual) missingDates.push('PO Issuance');
                } else {
                    if (!task.milestones.prices_confirm_actual) missingDates.push('Price Confirmation');
                    if (!task.milestones.comparison_actual) missingDates.push('Comparison');
                    if (!task.milestones.po_issuance_actual) missingDates.push('PO Issuance');
                }

                if (missingDates.length > 0) {
                    alert(`Cannot mark as complete. Missing actual dates for: ${missingDates.join(', ')}`);
                    return;
                }

                if (!confirm('Mark this task as complete?')) return;

                const updatedTask = {
                    ...task,
                    status: 'Closed',
                    completion_date: new Date().toISOString().split('T')[0],
                    performance_score: ScoringService.calculateTaskPerformanceScore({...task, status: 'Closed'}),
                    last_score_calculation: new Date().toISOString(),
                    last_updated: new Date().toISOString()
                };

                await db.saveTask(updatedTask);
                
                // Update cache
                const taskIndex = db.cache.tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    db.cache.tasks[taskIndex] = updatedTask;
                }
                
                Render.taskList();
                
            } catch (error) {
                console.error('Error completing task:', error);
                alert('Error completing task: ' + error.message);
            }
        };

        window.handleHoldTask = async (taskId) => {
            if (!confirm('Put this task on hold?')) return;
            
            try {
                const tasks = db.getTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                const updatedTask = {
                    ...task,
                    status: 'On Hold'
                };

                await db.saveTask(updatedTask);
                
                // Update cache
                const taskIndex = db.cache.tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    db.cache.tasks[taskIndex] = updatedTask;
                }
                
                Render.taskList();
                
            } catch (error) {
                console.error('Error holding task:', error);
                alert('Error holding task: ' + error.message);
            }
        };

        window.handleCancelTask = async (taskId) => {
            if (!confirm('Cancel this task? This action will mark it as cancelled but not delete it.')) return;
            
            try {
                const tasks = db.getTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                const updatedTask = {
                    ...task,
                    status: 'Cancelled',
                    cancellation_date: new Date().toISOString().split('T')[0]
                };

                await db.saveTask(updatedTask);
                
                // Update cache
                const taskIndex = db.cache.tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    db.cache.tasks[taskIndex] = updatedTask;
                }
                
                Render.taskList();
                
            } catch (error) {
                console.error('Error cancelling task:', error);
                alert('Error cancelling task: ' + error.message);
            }
        };

        window.updateWeightDisplayModal = (value) => {
            const weightValue = document.getElementById('weightValueModal');
            if (!weightValue) return;
            
            const descriptions = {
                1: 'Simple (1)', 2: 'Simple (2)', 3: 'Routine (3)',
                4: 'Standard (4)', 5: 'Standard (5)', 6: 'Important (6)',
                7: 'Critical (7)', 8: 'Critical (8)', 9: 'Emergency (9)', 10: 'Emergency (10)'
            };
            
            weightValue.textContent = descriptions[value] || `Weight (${value})`;
            weightValue.className = `font-bold ${value <= 3 ? 'text-green-600' : value <= 6 ? 'text-orange-600' : value <= 8 ? 'text-red-600' : 'text-red-700'}`;
        };

        window.handleWeightOverride = async (e, taskId) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newWeight = parseInt(formData.get('new_weight'));
            const reason = formData.get('reason');
            
            if (!reason.trim()) {
                alert('Please provide a reason for the weight change');
                return;
            }
            
            try {
                const tasks = db.getTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                if (newWeight === task.task_weight) {
                    alert('New weight is the same as current weight');
                    return;
                }

                const updatedTask = {
                    ...task,
                    task_weight: newWeight,
                    weight_modified_by: currentUser.id,
                    weight_modified_at: new Date().toISOString(),
                    weight_modification_reason: reason,
                    last_updated: new Date().toISOString()
                };

                await db.saveTask(updatedTask);
                
                // Update cache
                const taskIndex = db.cache.tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    db.cache.tasks[taskIndex] = updatedTask;
                }
                
                document.getElementById('modal-overlay').remove();
                Render.taskList();
                
                // Show success message
                setTimeout(() => {
                    alert(`Task weight updated from ${task.task_weight} to ${newWeight}.\nReason: ${reason}`);
                }, 500);
                
            } catch (error) {
                console.error('Error updating task weight:', error);
                alert('Error updating task weight: ' + error.message);
            }
        };

        window.handleReassignTask = async (e, taskId) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newOwnerId = formData.get('new_owner');
            const reason = formData.get('reassign_reason');
            
            if (!newOwnerId) {
                alert('Please select a new assignee');
                return;
            }
            
            try {
                const tasks = db.getTasks();
                const users = db.getUsers();
                const task = tasks.find(t => t.id === taskId);
                const newOwner = users.find(u => u.id === newOwnerId);
                const oldOwner = users.find(u => u.id === task.owner_id);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                if (newOwnerId === task.owner_id) {
                    alert('Task is already assigned to this user');
                    return;
                }

                // Determine if reassignment needs approval
                let newStatus = task.status;
                if (newOwner && newOwner.role === 'engineer') {
                    // Check if current user is a manager of the new assignee
                    const isManager = ['manager', 'director', 'vp', 'admin'].includes(currentUser.role) && 
                                     AuthService.isManagerOf(currentUser.id, newOwnerId);
                    
                    // If not a manager and task isn't already pending approval, set to pending approval
                    if (!isManager && task.status !== 'Pending Approval') {
                        newStatus = 'Pending Approval';
                    } else if (isManager && task.status === 'Pending Approval') {
                        newStatus = 'Pending'; // Manager assignment, no approval needed
                    }
                }

                const updatedTask = {
                    ...task,
                    owner_id: newOwnerId,
                    status: newStatus
                };

                await db.saveTask(updatedTask);
                
                // Update cache
                const taskIndex = db.cache.tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    db.cache.tasks[taskIndex] = updatedTask;
                }
                
                document.getElementById('modal-overlay').remove();
                Render.taskList();
                
                // Show success message
                const successMsg = reason ? 
                    `Task ${task.pr_no} successfully reassigned from ${oldOwner.name} to ${newOwner.name}.\nReason: ${reason}` :
                    `Task ${task.pr_no} successfully reassigned from ${oldOwner.name} to ${newOwner.name}`;
                
                setTimeout(() => {
                    alert(successMsg);
                }, 500);
                
            } catch (error) {
                console.error('Error reassigning task:', error);
                alert('Error reassigning task: ' + error.message);
            }
        };

        window.handleReopenTask = async (taskId) => {
            if (!confirm('Re-open this completed task? This will change the status back to Pending and clear the completion date.')) return;
            
            try {
                const tasks = db.getTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                if (task.status !== 'Closed') {
                    alert('Only closed tasks can be re-opened');
                    return;
                }

                const updatedTask = {
                    ...task,
                    status: 'Pending',
                    completion_date: null
                };

                await db.saveTask(updatedTask);
                
                // Update cache
                const taskIndex = db.cache.tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    db.cache.tasks[taskIndex] = updatedTask;
                }
                
                Render.taskList();
                
                // Show success message
                setTimeout(() => {
                    alert('Task successfully re-opened and set to Pending status');
                }, 500);
                
            } catch (error) {
                console.error('Error re-opening task:', error);
                alert('Error re-opening task: ' + error.message);
            }
        };

        window.handleResumeTask = async (taskId) => {
            if (!confirm('Resume this task?')) return;
            
            try {
                const tasks = db.getTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                const updatedTask = {
                    ...task,
                    status: 'Pending',
                    cancellation_date: null
                };

                await db.saveTask(updatedTask);
                
                // Update cache
                const taskIndex = db.cache.tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    db.cache.tasks[taskIndex] = updatedTask;
                }
                
                Render.taskList();
                
            } catch (error) {
                console.error('Error resuming task:', error);
                alert('Error resuming task: ' + error.message);
            }
        };

        window.handleAddNewRemark = async (e, taskId) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newRemarkText = formData.get('new_remark');
            
            if (!newRemarkText.trim()) {
                alert('Please enter a note before saving');
                return;
            }
            
            try {
                const tasks = db.getTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                // Get existing remarks or initialize empty array
                const existingRemarks = Array.isArray(task.remarks) ? task.remarks : [];
                
                // Create new remark entry
                const newRemarkEntry = {
                    text: newRemarkText.trim(),
                    timestamp: new Date().toISOString()
                };
                
                // Add new entry to the timeline
                const updatedRemarks = [...existingRemarks, newRemarkEntry];

                const updatedTask = {
                    ...task,
                    remarks: updatedRemarks,
                    last_updated: new Date().toISOString()
                };

                await db.saveTask(updatedTask);
                
                // Update cache
                const taskIndex = db.cache.tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    db.cache.tasks[taskIndex] = updatedTask;
                }
                
                document.getElementById('modal-overlay').remove();
                Render.taskList();
                
                // Show success message
                setTimeout(() => {
                    alert(`ðŸ“ Note added successfully!\\n\\nYou now have ${updatedRemarks.length} notes in the timeline.`);
                }, 500);
                
            } catch (error) {
                console.error('Error adding remark:', error);
                alert('Error saving note: ' + error.message);
            }
        };

        window.updateNewWeightDisplay = (value) => {
            const newWeightValue = document.getElementById('newWeightValue');
            if (newWeightValue) {
                let description = 'Standard';
                if (value >= 8) description = 'Critical';
                else if (value >= 6) description = 'Important';
                else if (value >= 4) description = 'Important';
                else description = 'Routine';
                
                newWeightValue.textContent = `${description} (${value})`;
                newWeightValue.className = `font-bold ${value >= 8 ? 'text-red-600' : value >= 6 ? 'text-yellow-600' : 'text-orange-600'}`;
            }
        };

        window.refreshGanttChart = () => {
            const tasks = DataService.getMyTeamTasks();
            const users = db.getUsers();
            Render.initGanttChart(tasks, users);
        };

        window.updateWeightDisplay = (value) => {
            const weightValue = document.getElementById('weightValue');
            if (weightValue) {
                let description = 'Standard';
                if (value >= 8) description = 'Critical';
                else if (value >= 6) description = 'Important';
                else if (value >= 4) description = 'Important';
                else description = 'Routine';
                
                weightValue.textContent = `${description} (${value})`;
                weightValue.className = `font-bold ${value >= 8 ? 'text-red-600' : value >= 6 ? 'text-yellow-600' : 'text-blue-600'}`;
            }
        };

        window.updateActionBy = async (taskId, newActionBy) => {
            try {
                const tasks = db.getTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                // Update the action_by field in the task
                const updatedTask = {
                    ...task,
                    action_by: newActionBy
                };

                await db.saveTask(updatedTask);
                
                // Update the cache without reloading from database
                const taskIndex = db.cache.tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    db.cache.tasks[taskIndex].action_by = newActionBy;
                }
                
                console.log(`Updated action by for task ${taskId} to ${newActionBy}`);
                
            } catch (error) {
                console.error('Error updating action by:', error);
                alert('Error updating action by: ' + error.message);
                // Revert the dropdown selection on error
                const dropdown = event.target;
                const originalActionBy = dropdown.getAttribute('data-original-action-by');
                if (originalActionBy) {
                    dropdown.value = originalActionBy;
                }
            }
        };

        window.updateCurrentStage = async (taskId, newStage) => {
            try {
                const tasks = db.getTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task not found');
                    return;
                }

                // Update the current stage field in the task
                const updatedTask = {
                    ...task,
                    current_stage: newStage
                };

                await db.saveTask(updatedTask);
                
                // Update the cache without reloading from database
                const taskIndex = db.cache.tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    db.cache.tasks[taskIndex].current_stage = newStage;
                }
                
                console.log(`Updated current stage for task ${taskId} to ${newStage}`);
                
            } catch (error) {
                console.error('Error updating current stage:', error);
                alert('Error updating current stage: ' + error.message);
                // Revert the dropdown selection on error
                const dropdown = event.target;
                const originalStage = dropdown.getAttribute('data-original-stage');
                if (originalStage) {
                    dropdown.value = originalStage;
                }
            }
        };

        window.updateWeightDisplay = (value) => {
            const weightValue = document.getElementById('weightValue');
            if (!weightValue) return;
            
            const descriptions = {
                1: 'Simple (1)', 2: 'Simple (2)', 3: 'Routine (3)',
                4: 'Standard (4)', 5: 'Standard (5)', 6: 'Important (6)',
                7: 'Critical (7)', 8: 'Critical (8)', 9: 'Emergency (9)', 10: 'Emergency (10)'
            };
            
            weightValue.textContent = descriptions[value] || `Weight (${value})`;
            weightValue.className = `font-bold ${value <= 3 ? 'text-green-600' : value <= 6 ? 'text-blue-600' : value <= 8 ? 'text-orange-600' : 'text-red-600'}`;
        };

        window.toggleClosedTasks = () => {
            const showClosed = document.getElementById('showClosed').checked;
            const tasks = DataService.getMyTeamTasks();
            const users = db.getUsers();
            
            document.getElementById('taskTableBody').innerHTML = Render.renderTaskRows(tasks, users, showClosed);
        };

        window.handleLogin = async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            Render.showLoading();
            
            try {
                if (await AuthService.login(u, p)) {
                    Render.dashboard();
                } else {
                    Render.login();
                    errorDiv.textContent = 'Invalid credentials or connection error';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                Render.login();
                errorDiv.textContent = 'Database connection failed. Please check your connection.';
                errorDiv.classList.remove('hidden');
            }
        };

        window.handleTaskSave = async (e, existingId) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const type = formData.get('type');
            
            try {
                // Determine Owner & Status
                let ownerId = currentUser.id;
                let status = 'Pending'; // Default status for new tasks
                
                // If assign_to field exists, use its value
                if (formData.get('assign_to')) {
                    ownerId = formData.get('assign_to');
                    
                    // Check if assigned to someone else requiring approval
                    if (ownerId !== currentUser.id) {
                        const assignee = db.getUsers().find(u => u.id === ownerId);
                        if (assignee && assignee.role === 'engineer') {
                            // Check if current user is a manager of the assignee
                            const isManager = ['manager', 'director', 'vp', 'admin'].includes(currentUser.role) && 
                                             AuthService.isManagerOf(currentUser.id, ownerId);
                            
                            // If not a manager, requires approval
                            if (!isManager) {
                                status = 'Pending Approval';
                            }
                            // If is a manager, status stays 'Pending' (no approval needed)
                        }
                    }
                }

                // Build milestones based on type
                let milestones = {};
                if (type === 'new') {
                    milestones = {
                        vendor_list: formData.get('vendor_list') || null,
                        rfq_float: formData.get('rfq_float') || null,
                        target_prices: formData.get('target_prices') || null,
                        comparison: formData.get('comparison') || null,
                        // Material submittal milestones (for permanent PRs only)
                        material_submittal_required: formData.get('material_submittal_required') || null,
                        material_submittal_submitted: formData.get('material_submittal_submitted') || null,
                        material_submittal_approved: formData.get('material_submittal_approved') || null,
                        po_issuance: formData.get('po_issuance') || null,
                    };
                } else {
                    milestones = {
                        prices_confirm: formData.get('prices_confirm') || null,
                        comparison: formData.get('comparison_rep') || null,
                        po_issuance: formData.get('po_issuance_rep') || null,
                    };
                }

                const taskData = {
                    id: existingId || null,
                    owner_id: ownerId,
                    pr_no: formData.get('pr_no'),
                    project: formData.get('project'),
                    type: type,
                    is_permanent: formData.get('is_permanent') === 'on',
                    assignment_date: formData.get('assignment_date'),
                    task_weight: parseInt(formData.get('task_weight')) || 5,
                    weight_set_by: existingId ? null : currentUser.id, // Only set for new tasks
                    action_by: existingId ? undefined : 'proc_eng_buyer', // Default to Proc Eng./Buyer for new tasks
                    milestones: milestones,
                    status: status,
                    last_updated: new Date().toISOString()
                };
                
                await db.saveTask(taskData);
                document.getElementById('modal-overlay').remove();
                Render.taskList();
            } catch (error) {
                alert('Error saving task: ' + error.message);
            }
        };

        window.handleMilestoneUpdate = async (e, taskId) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const action = e.submitter.value;
            
            try {
                const tasks = db.getTasks();
                const task = tasks.find(t => t.id === taskId);
                
                // Build updated milestones
                const updatedMilestones = { ...task.milestones };
                
                if (task.type === 'new') {
                    ['vendor_list', 'rfq_float', 'target_prices', 'comparison', 'po_issuance'].forEach(key => {
                        const actualValue = formData.get(`${key}_actual`);
                        if (actualValue) {
                            updatedMilestones[`${key}_actual`] = actualValue;
                        }
                    });
                } else {
                    ['prices_confirm', 'comparison', 'po_issuance'].forEach(key => {
                        const actualValue = formData.get(`${key}_actual`);
                        if (actualValue) {
                            updatedMilestones[`${key}_actual`] = actualValue;
                        }
                    });
                }
                
                // Also add new remark if provided
                const quickRemarks = formData.get('quick_remarks');
                if (quickRemarks && quickRemarks.trim()) {
                    const existingRemarks = Array.isArray(task.remarks) ? task.remarks : [];
                    const newRemarkEntry = {
                        text: quickRemarks.trim(),
                        timestamp: new Date().toISOString()
                    };
                    task.remarks = [...existingRemarks, newRemarkEntry];
                }
                
                const taskData = {
                    ...task,
                    milestones: updatedMilestones,
                    status: action === 'complete' ? 'Closed' : task.status,
                    completion_date: action === 'complete' ? new Date().toISOString().split('T')[0] : task.completion_date,
                    performance_score: action === 'complete' ? ScoringService.calculateTaskPerformanceScore({
                        ...task,
                        milestones: updatedMilestones,
                        status: 'Closed'
                    }) : task.performance_score,
                    last_score_calculation: action === 'complete' ? new Date().toISOString() : task.last_score_calculation,
                    last_updated: new Date().toISOString() // Track when any change is made
                };
                
                await db.saveTask(taskData);
                document.getElementById('modal-overlay').remove();
                Render.taskList();
                
                // Show success notification with score if task was completed
                if (action === 'complete') {
                    setTimeout(() => {
                        const score = taskData.performance_score;
                        alert(`âœ… Task completed successfully!\\n\\nðŸ“Š Performance Score: ${score ? score.toFixed(1) : 'N/A'}/10\\n\\nYour overall score has been updated.`);
                    }, 500);
                }
            } catch (error) {
                alert('Error updating milestones: ' + error.message);
            }
        };

        window.handleApprove = async (taskId) => {
            if(!confirm('Approve this task?')) return;
            
            try {
                const tasks = db.getTasks();
                const task = tasks.find(x => x.id === taskId);
                if(task) {
                    const taskData = { ...task, status: 'Pending' };
                    await db.saveTask(taskData);
                    Render.taskList();
                }
            } catch (error) {
                alert('Error approving task: ' + error.message);
            }
        };

        window.handleUserSave = async (e, userId) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                // Handle multiple select
                const reportsToOptions = e.target.elements.reports_to.options;
                const reportsTo = [];
                for (let i = 0; i < reportsToOptions.length; i++) {
                    if (reportsToOptions[i].selected) {
                        reportsTo.push(reportsToOptions[i].value);
                    }
                }

                const userData = {
                    id: userId,
                    name: formData.get('name'),
                    role: formData.get('role'),
                    reports_to: reportsTo
                };

                if (!userId) {
                    userData.username = formData.get('username');
                    userData.password = formData.get('password');
                }

                await db.saveUser(userData);
                document.getElementById('modal-overlay').remove();
                Render.adminPanel();
            } catch (error) {
                alert('Error saving user: ' + error.message);
            }
        };

        window.handleDeleteUser = async (userId) => {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
            
            try {
                await db.deleteUser(userId);
                Render.adminPanel();
            } catch (error) {
                alert('Error deleting user: ' + error.message);
            }
        };

        window.toggleFormFields = () => {
            const type = document.getElementById('typeSelect').value;
            if (type === 'new') {
                document.getElementById('new-request-fields').classList.remove('hidden');
                document.getElementById('repeat-request-fields').classList.add('hidden');
                // Show/hide material submittal based on permanent checkbox
                toggleMaterialSubmittalSection();
            } else {
                document.getElementById('new-request-fields').classList.add('hidden');
                document.getElementById('repeat-request-fields').classList.remove('hidden');
            }
        };

        window.toggleMaterialSubmittalSection = () => {
            const isPermanent = document.querySelector('input[name="is_permanent"]').checked;
            const materialSection = document.getElementById('material-submittal-section');
            
            if (materialSection) {
                if (isPermanent) {
                    materialSection.classList.remove('hidden');
                } else {
                    materialSection.classList.add('hidden');
                    // Clear material submittal fields when hidden
                    const materialFields = materialSection.querySelectorAll('input[type="date"], input[type="radio"]');
                    materialFields.forEach(field => {
                        if (field.type === 'radio') {
                            field.checked = false;
                        } else {
                            field.value = '';
                        }
                    });
                    document.getElementById('material-submittal-fields').classList.add('hidden');
                }
            }
        };

        window.toggleMaterialSubmittalFields = () => {
            const isRequired = document.querySelector('input[name="material_submittal_required"]:checked')?.value === 'Yes';
            const fieldsSection = document.getElementById('material-submittal-fields');
            
            if (fieldsSection) {
                if (isRequired) {
                    fieldsSection.classList.remove('hidden');
                } else {
                    fieldsSection.classList.add('hidden');
                    // Clear date fields when hidden
                    const dateFields = fieldsSection.querySelectorAll('input[type="date"]');
                    dateFields.forEach(field => field.value = '');
                }
            }
        };

        // Initialize App
        Render.init();

    </script>
</body>
</html>
